# 小学校理科学習支援システム - 段階別言語化支援版

小学生の理科学習における予想と考察を支援するFlask Webアプリケーションです。AI（OpenAI API）との対話を通じて、産婆法的アプローチにより学習者の既習事項・経験を引き出し、段階別の言語化支援により根拠のある予想・考察の作成を支援します。

## 🎯 主な機能

### 👨‍🎓 学習者用機能
- **出席番号選択** - 1〜30番からの選択（カード形式UI）
- **学習単元選択** - 9つの理科単元から選択
- **段階別AI対話支援**
  - **予想段階**: 体験的表現受容 → 一般表現変換 → 経験関連付け → 根拠明確化
  - **考察段階**: 結果言語化 → 一般表現変換 → 予想比較 → 経験・既習事項関連 → 概念化足掛かり
- **AI選択肢機能** - 詰まった時の入力支援（使用状況を記録）
- **リライト支援機能** - 対話内容を基に学習者の発言をまとめた文章提案
  - 予想文自動生成（対話内容のみを基に作成）
  - 考察文自動生成（結果・予想比較・経験関連付けを含む）
- **実験実施確認** - 実験実行の確認

### 👩‍🏫 教員用機能
- **認証システム** - 教員専用ログイン
- **段階別プロンプト管理** - 予想・考察の段階に応じた対話プロンプトのカスタマイズ
  - 単元別プロンプト編集・保存（言語化支援パターン内蔵）
  - リアルタイムプロンプトテスト（OpenAI API連携）
  - Markdownプレビュー機能
  - 理科の見方・考え方を活用した教育的配慮
- **学習ログ分析** - 学生の言語化プロセスと学習過程の詳細確認
- **学生別データ表示** - 出席番号・単元・日付別のフィルタリング
- **詳細な学習記録** - タイムライン形式での学習過程表示
- **AI学習分析** - OpenAIによる自動分析と評価
  - 個別学生分析（言語化プロセス、概念形成過程など）
  - クラス全体分析（学習傾向、よくある誤解、指導提案など）
- **選択肢使用状況確認** - 学習者のAI選択肢依存度表示

## 📚 対応学習単元

- 空気の温度と体積
- 水の温度と体積
- 金属の温度と体積
- 金属のあたたまり方
- 水のあたたまり方
- 空気のあたたまり方
- ふっとうした時の泡の正体
- 水を熱し続けた時の温度と様子
- 冷やした時の水の温度と様子

## 🛠️ 技術仕様

- **バックエンド**: Flask (Python)
- **AI**: OpenAI API (gpt-4o-mini)
- **フロントエンド**: HTML5, CSS3, JavaScript, Bootstrap 5
- **データ保存**: JSON形式のログファイル（logs/learning_log_YYYYMMDD.json）
- **セッション管理**: Flaskセッション
- **プロンプト管理**: Markdown形式（prompts/単元名.md）
- **UI/UX**: レスポンシブデザイン、カスタムCSS変数システム

## 🚀 セットアップ・起動方法

### 1. 必要なパッケージのインストール
```bash
pip install -r requirements.txt
```

### 2. 環境変数の設定
`.env`ファイルを作成して、OpenAI APIキーを設定：
```env
OPENAI_API_KEY=your_actual_openai_api_key_here
```

### 3. アプリケーションの起動
```bash
python app.py
```

### 4. アクセス
- 学習者用: http://localhost:5014
- 教員用: http://localhost:5014/teacher

## 💡 教育的配慮

### 段階別言語化支援システム
#### 予想段階（概念化は行わない）
1. **体験的表現の受容**: オノマトペや感覚的表現を価値づけ
2. **一般表現への変換**: 「〜を別の言い方でできるかな？」で支援
3. **経験との関連付け**: 日常体験・既習事項の活用
4. **根拠の明確化**: 予想の根拠を言語化

#### 考察段階（概念化への足掛かりまで）
1. **結果の言語化**: 実験結果の体験的表現を受容
2. **一般表現への変換**: 科学的表現への言語化支援
3. **予想との比較**: 「予想と同じ？違った？」
4. **経験・既習事項との関連**: 学習内容の関連付け
5. **概念化への足掛かり**: 「このことから何が言えそう？」

### 産婆法的アプローチ
- AIが答えを誘導せず、学習者の経験を引き出す
- 「なぜそう思うのか」を問いかけて根拠を探る
- 理科の見方・考え方（量的・質的・共通性・時間空間的視点）を活用

### リライト支援機能
- **予想文生成**: 対話内容のみを基に学習者の発言をまとめた予想文を提案
- **考察文生成**: 結果・予想比較・経験関連付けを含む考察文を提案
- **足場かけ**: 紙面記述への移行を支援

### AI支援機能
- **選択肢機能**: 詰まった時の入力支援（使用状況を記録し教員が確認可能）
- **プロンプト最適化**: マークダウン記法や特殊記号の自動除去
- **エラーハンドリング**: API呼び出し失敗時の適切な処理

## 🎨 UI/UX特徴

- **クリーンデザイン**: 白ベース・ライトブルーアクセントの小学生向けUI
- **直感的操作**: カード形式の選択とチャット形式の対話
- **レスポンシブデザイン**: スマートフォン・タブレット対応
- **CSS変数システム**: 統一されたデザインテーマ管理
- **アクセシビリティ**: 小学生にも使いやすいインターフェース
- **教員ダッシュボード**: 学習分析結果の視覚的表示

## 🔧 プロンプト管理システム（NEW）

### 単元別プロンプトカスタマイズ
このシステムは各理科単元に特化したAI対話プロンプトを個別管理できます。

- **単元別編集** - 9つの理科単元それぞれに専用プロンプト
- **Markdown対応** - 見出し、リスト、強調などの記法をサポート
- **リアルタイムテスト** - 編集中のプロンプトをその場でOpenAI APIテスト
- **プレビュー機能** - Markdownの表示確認
- **ファイル管理** - `prompts/[単元名].md`として直接ファイル保存

### プロンプト設計ガイド
教員がプロンプト編集時に参考にできる指針：
- **役割定義**: AIの役割を明確に定義
- **教育目標**: その単元の学習目標
- **指導方針**: 対話の進め方や注意点
- **質問例**: 効果的な質問パターン
- **具体性**: 抽象的でなく具体的な表現を使用
- **年齢適応**: 小学生にわかりやすい表現
- **誤解対策**: よくある誤解への対処法
- **実体験重視**: 身近な例との関連付け

### 使用方法
1. 教員ダッシュボードから「プロンプト管理」をクリック
2. 編集したい単元を選択
3. Markdownエディタでプロンプトを編集
4. テスト機能で動作確認
5. 保存して即座に学習者対話に反映

## 📊 学習支援分析機能

### AI学習分析
このシステムは「見方・考え方」を働かせる探究活動における学習支援を目的としています。

- **個別学習分析**
  - 学習者一人ひとりの学習プロセスをOpenAI APIが分析
  - **予想段階**: 経験や既習事項の活用状況を確認
  - **考察段階**: 結果の理解、予想との比較、日常生活との関連付けを確認
  - 生成AIとの対話を通じた学習プロセスの支援

- **クラス全体の学習分析**
  - クラス全体の学習傾向把握
  - 共通する学習課題の特定
  - 効果的な学習支援方法の抽出
  - 今後の学習支援提案

### 教育的背景
- **産婆法的アプローチ**: AIが答えを与えず、児童の経験を引き出す
- **個別最適な支援**: 児童の応答レベルに応じた問いかけ
- **本質的理解の促進**: 対話プロセスを通じた思考の構造化

### 学習ログ管理
- 日付別ログファイル自動生成
- 学習者・単元・日付での柔軟なフィルタリング
- 詳細な学習過程の記録（タイムライン形式表示）

## 📁 ディレクトリ構造

```
science-sup/
├── app.py                      # メインアプリケーション
├── requirements.txt            # 依存関係
├── .env                       # 環境変数（要設定）
├── logs/                      # 学習ログ（自動生成）
│   └── learning_log_YYYYMMDD.json
├── prompts/                   # 単元別プロンプト（NEW）
│   ├── template.md            # プロンプトテンプレート
│   ├── 空気の温度と体積.md      # 各単元専用プロンプト
│   ├── 水の温度と体積.md
│   └── ...（9つの単元）
├── templates/                 # HTMLテンプレート
│   ├── base.html
│   ├── index.html
│   ├── select_number.html
│   ├── select_unit.html
│   ├── prediction.html
│   ├── experiment.html
│   ├── reflection.html
│   └── teacher/               # 教員用テンプレート
│       ├── login.html
│       ├── dashboard.html
│       ├── logs.html
│       ├── prompts.html       # プロンプト管理（NEW）
│       ├── prompt_edit.html   # プロンプト編集（NEW）
│       ├── student_detail.html
│       ├── analysis.html
│       └── student_analysis.html
├── static/                    # 静的ファイル
│   └── css/
│       └── style.css          # 白ベース・ライトブルーデザイン
└── tasks/                     # 単元別課題文
    ├── 空気の温度と体積.txt
    ├── 水の温度と体積.txt
    └── ...（9つの単元）
```

##  データ形式

### 学習ログ構造
```json
{
  "timestamp": "2025-08-14T10:30:00.000000",
  "student_number": "1",
  "unit": "空気の温度と体積",
  "log_type": "prediction_chat",
  "data": {
    "user_message": "学習者の入力",
    "ai_response": "AIの応答",
    "conversation_count": 1,
    "used_suggestion": false,
    "suggestion_index": null
  }
}
```

### ログタイプ
- `prediction_chat`: 予想段階の対話
- `prediction_summary`: 予想のまとめ（リライト支援）
- `reflection_chat`: 考察段階の対話
- `final_summary`: 最終考察（リライト支援）

### プロンプトファイル構造（段階別言語化支援対応）
```markdown
# 単元名 - 対話プロンプト

## 役割設定
あなたは小学生向けの産婆法を実践する理科指導者です。

## 言語化支援の重要な視点
### 段階的言語表現の支援
1. 体験的表現の受容
2. 一般表現への変換
3. 科学的概念への発展

### 理科の見方・考え方の活用
- 量的・関係的視点、質的・実体的視点
- 共通性・多様性視点、時間的・空間的視点

## 対話の進め方（段階別）
### 予想段階での対話
1-4回目: 体験受容→一般表現変換→経験関連付け→根拠明確化

### 考察段階での対話
1-5回目: 結果言語化→一般表現変換→予想比較→経験関連→概念化足掛かり

## 単元固有の指導ポイント
- 重要な概念や注意点

## 学習者が理解すべき概念
- 理解すべき内容
```

## 🔬 言語化支援の特徴

### オノマトペ→一般表現→科学的概念の段階的支援
```
「ぶくぶく」→「泡が出ている」→「水蒸気が発生している」
「パンパン」→「ふくらんでいる」→「体積が大きくなっている」
「じりじり」→「だんだん熱くなる」→「熱伝導により温度が上昇」
```

### 対話例：予想段階
```
児童: 「風船がパンパンになると思う」
AI: 「パンパンを別の言い方でできないかな？」
児童: 「大きくなる」
AI: 「夏のタイヤで似たような経験はない？」
児童: 「タイヤも大きくなってた」
AI: 「なぜそう思ったの？」
```

### 対話例：考察段階
```
児童: 「実験で風船がパンパンになった」
AI: 「パンパンを別の言い方でできるかな？」
児童: 「ふくらんだ」
AI: 「予想と同じだった？」
児童: 「同じだった」
AI: 「このことから空気について何が言えそう？」
```

## 想定される誤解・つまずき
- よくある誤解

## 日常生活との関連
- 身近な例との関連付け
```

## 🚨 注意事項

- **APIキー管理**: `.env`ファイルのOpenAI APIキーは適切に管理してください
- **認証システム**: 本番運用時は適切な教員認証システムを実装してください
- **ポート設定**: デフォルトポートは5014です（app.py最下部で変更可能）
- **データ保存**: 学習ログは`logs/`ディレクトリに日付別で自動保存されます
- **プロンプト管理**: プロンプトファイルは`prompts/`ディレクトリに単元別で保存されます
- **セッション管理**: Flaskセッションを使用（本番環境では適切なSecret Keyに変更）

## 📖 プロンプト管理機能の使用方法

### プロンプトの編集
1. 教員ログイン後、ダッシュボードから「プロンプト管理」をクリック
2. 編集したい単元を選択
3. Markdownエディタでプロンプト内容を編集
4. 「プロンプトをテスト」でOpenAI APIとの動作確認
5. 「保存」で`prompts/[単元名].md`に直接保存

### テスト機能
- 編集中のプロンプトをリアルタイムでOpenAI APIテスト
- テスト用メッセージでAI応答を確認
- プロンプトプレビューも同時表示

## 🎓 開発・カスタマイズ

- **単元追加**: `tasks/`ディレクトリに新しい課題文ファイルを追加
- **プロンプト追加**: `prompts/`ディレクトリに新しい単元プロンプトを追加
- **スタイル変更**: `static/css/style.css`でデザインをカスタマイズ
- **AI応答調整**: プロンプト管理機能で各単元のAI応答を調整

## 🆕 最新アップデート（2025年8月18日）

- **AI APIの変更**: Gemini API から OpenAI API (GPT-4o mini) に移行
- **プロンプト最適化**: OpenAI向けに最適化されたプロンプト設計
- **UI大幅リニューアル**: 白ベース・ライトブルーの小学生・教師向けクリーンデザイン
- **プロンプト管理システム導入**: 単元別プロンプトのカスタマイズ機能
- **教師用編集インターフェース**: Markdown対応の直感的編集画面
- **リアルタイムテスト機能**: プロンプト編集中のOpenAI APIテスト
- **ファイルベース管理**: プロンプトの直接ファイル読み書き
- **CSS変数システム**: 統一されたデザインテーマ管理
- **複雑機能の整理**: Digital Learning Twin機能などを削除し、シンプルな教育支援に集中
- **セキュリティ強化**: デモ用認証情報とセッション復帰機能を削除
- **レスポンシブ対応強化**: モバイル・タブレットでの使いやすさ向上

## 🔗 関連リンク

- **GitHub リポジトリ**: https://github.com/nov11masaki/scienceapp2
- **OpenAI API**: https://platform.openai.com/
- **Flask ドキュメント**: https://flask.palletsprojects.com/
- **Bootstrap 5**: https://getbootstrap.com/

## 🚀 Renderでのデプロイ

### 前提条件
- GitHubアカウント
- Renderアカウント（無料プランで利用可能）
- OpenAI APIキー

### デプロイ手順

1. **GitHubリポジトリの準備**
   ```bash
   git add .
   git commit -m "Renderデプロイ対応"
   git push origin main
   ```

2. **Render Webサービスの作成**
   - [Render Dashboard](https://dashboard.render.com)にログイン
   - "New +" → "Web Service"を選択
   - GitHubリポジトリを連携
   - `nov11masaki/scienceapp2`を選択

3. **設定項目**
   - **Name**: `scienceapp2`（任意の名前）
   - **Environment**: `Python 3`
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `gunicorn --bind 0.0.0.0:$PORT app:app`
   - **Plan**: `Free`

4. **環境変数の設定**
   - `OPENAI_API_KEY`: あなたのOpenAI APIキー
   - `ENVIRONMENT`: `production`

5. **デプロイ実行**
   - "Create Web Service"をクリック
   - 自動的にビルドとデプロイが開始されます

### 注意事項
- 無料プランでは、非アクティブ時にサービスがスリープします
- 初回アクセス時に起動に時間がかかる場合があります
- `.env`ファイルは`.gitignore`により除外されています（セキュリティ対策）

---

このシステムは、小学校理科教育における「予想→実験→考察」の学習サイクルを、AI技術を活用して効果的に支援することを目的としています。産婆法的アプローチにより、学習者の主体的な学びを促進し、教員には詳細な学習分析機能を提供します。
