{% extends "base.html" %}

{% block title %}äºˆæƒ³ãƒ»è€ƒå¯Ÿåˆ†æ{% endblock %}

{% block content %}
<div class="analysis-dashboard-page">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="analysis-header">
        <div class="header-container">
            <h1><i class="fas fa-microscope"></i> äºˆæƒ³ãƒ»è€ƒå¯Ÿåˆ†æ</h1>
            <p>å…ç«¥ã®äºˆæƒ³ã‚„é–¢ä¿‚ä»˜ã‘ã®å‚¾å‘ã‚’åˆ†æã—ã¾ã™</p>
        </div>
    </header>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="analysis-filters">
        <div class="filter-group">
            <label for="unitSelect">å˜å…ƒé¸æŠ:</label>
            <select id="unitSelect">
                <option value="">å…¨å˜å…ƒ</option>
                {% for unit in units %}
                <option value="{{ unit }}">{{ unit }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="analysisMode">åˆ†ææœŸé–“:</label>
            <select id="analysisMode" onchange="updateDateInputs()">
                <option value="single">æŒ‡å®šæ—¥ä»˜</option>
                <option value="period">æœŸé–“æŒ‡å®š</option>
                <option value="all">å…¨æœŸé–“</option>
            </select>
        </div>
        <div class="filter-group" id="singleDateGroup">
            <label for="dateInput">æ—¥ä»˜:</label>
            <input type="date" id="dateInput" />
        </div>
        <div class="filter-group" id="periodStartGroup">
            <label for="periodStart">é–‹å§‹æ—¥:</label>
            <input type="date" id="periodStart" />
        </div>
        <div class="filter-group" id="periodEndGroup">
            <label for="periodEnd">çµ‚äº†æ—¥:</label>
            <input type="date" id="periodEnd" />
        </div>
        <button onclick="loadAnalysis()" class="btn btn-primary">åˆ†æã‚’èª­ã¿è¾¼ã‚€</button>
    </section>

    <!-- åˆ†æçµæœ -->
    <section class="analysis-results">
        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-comments"></i></div>
                <div class="stat-content">
                    <h3>ç·å¯¾è©±æ•°</h3>
                    <p id="totalChats">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-lightbulb"></i></div>
                <div class="stat-content">
                    <h3>äºˆæƒ³ãƒãƒ£ãƒƒãƒˆ</h3>
                    <p id="predictionCount">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                <div class="stat-content">
                    <h3>è€ƒå¯Ÿãƒãƒ£ãƒƒãƒˆ</h3>
                    <p id="reflectionCount">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-flask"></i></div>
                <div class="stat-content">
                    <h3>ç†ç§‘ç”¨èªå«æœ‰ç‡</h3>
                    <p id="scienceTermRatio">-</p>
                </div>
            </div>
        </div>

        <!-- å˜å…ƒåˆ¥åˆ†æ -->
        <div class="analysis-content">
            <!-- ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»æ©Ÿæ¢°å­¦ç¿’åˆ†æ -->
            <div class="analysis-section insights-section">
                <h2><i class="fas fa-brain"></i> AIåˆ†æã«ã‚ˆã‚‹æœ‰æ„ç¾©ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h2>
                <div id="insightsAnalysis" class="insights-container">
                    <!-- ã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åˆ†æ -->
            <div class="analysis-section">
                <h2><i class="fas fa-object-group"></i> å¯¾è©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°</h2>
                <div id="clusteringAnalysis" class="clustering-container">
                    <!-- ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- äºˆæƒ³æ®µéšã®åˆ†æ -->
            <div class="analysis-section">
                <h2><i class="fas fa-lightbulb"></i> äºˆæƒ³æ®µéšã®åˆ†æ</h2>
                <div id="predictionAnalysis" class="unit-analysis-container">
                    <!-- å˜å…ƒã”ã¨ã®åˆ†æãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- è€ƒå¯Ÿæ®µéšã®åˆ†æ -->
            <div class="analysis-section">
                <h2><i class="fas fa-graduation-cap"></i> è€ƒå¯Ÿæ®µéšã®åˆ†æ</h2>
                <div id="reflectionAnalysis" class="unit-analysis-container">
                    <!-- å˜å…ƒã”ã¨ã®åˆ†æãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </section>

    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <div class="actions-section">
        <a href="/teacher/dashboard" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// åˆ†ææœŸé–“ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
function updateDateInputs() {
    const mode = document.getElementById('analysisMode').value;
    const singleDateGroup = document.getElementById('singleDateGroup');
    const periodStartGroup = document.getElementById('periodStartGroup');
    const periodEndGroup = document.getElementById('periodEndGroup');
    
    // å…¨ã¦ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
    singleDateGroup.style.display = 'none';
    periodStartGroup.classList.remove('visible');
    periodEndGroup.classList.remove('visible');
    
    if (mode === 'single') {
        singleDateGroup.style.display = 'flex';
    } else if (mode === 'period') {
        periodStartGroup.classList.add('visible');
        periodEndGroup.classList.add('visible');
    }
    // mode === 'all' ã®å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById('dateInput').value = today;
    document.getElementById('periodStart').value = '2025-01-01';
    document.getElementById('periodEnd').value = today;
});

// åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
function loadAnalysis() {
    const unit = document.getElementById('unitSelect').value;
    const mode = document.getElementById('analysisMode').value;
    
    let queryParams = `?unit=${encodeURIComponent(unit)}`;
    
    if (mode === 'single') {
        const date = document.getElementById('dateInput').value;
        if (!date) {
            alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        const formattedDate = date.replace(/-/g, '');
        queryParams += `&date=${formattedDate}`;
    } else if (mode === 'period') {
        const startDate = document.getElementById('periodStart').value;
        const endDate = document.getElementById('periodEnd').value;
        
        if (!startDate || !endDate) {
            alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        if (new Date(startDate) > new Date(endDate)) {
            alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
            return;
        }
        
        queryParams += `&start_date=${startDate.replace(/-/g, '')}&end_date=${endDate.replace(/-/g, '')}`;
    }
    // mode === 'all' ã®å ´åˆã¯æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã§å…¨æœŸé–“ã‚’å–å¾—

    fetch(`/teacher/analysis${queryParams}`)
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayAnalysis(data.analysis);
            } else {
                alert('åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        });
}

// åˆ†æçµæœã‚’è¡¨ç¤º
function displayAnalysis(analysis) {
    // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
    document.getElementById('totalChats').textContent = analysis.total_logs;
    document.getElementById('predictionCount').textContent = analysis.prediction_chats;
    document.getElementById('reflectionCount').textContent = analysis.reflection_chats;
    
    // å¹³å‡ç†ç§‘ç”¨èªå«æœ‰ç‡ã‚’è¨ˆç®—
    let totalScienceTermRatio = 0;
    let unitCount = 0;
    for (const [unit, analysis_data] of Object.entries(analysis.text_analysis || {})) {
        if (analysis_data.prediction && analysis_data.prediction.science_term_ratio) {
            totalScienceTermRatio += analysis_data.prediction.science_term_ratio;
            unitCount++;
        }
    }
    const avgRatio = unitCount > 0 ? (totalScienceTermRatio / unitCount).toFixed(1) : '-';
    document.getElementById('scienceTermRatio').textContent = avgRatio + '%';

    // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¡¨ç¤º
    displayInsights(analysis.insights);
    
    // ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°çµæœã‚’è¡¨ç¤º
    displayClustering(analysis.embeddings_analysis);

    // äºˆæƒ³æ®µéšã®åˆ†æã‚’è¡¨ç¤º
    displayPredictionAnalysis(analysis.predictions_by_unit, analysis.text_analysis);

    // è€ƒå¯Ÿæ®µéšã®åˆ†æã‚’è¡¨ç¤º
    displayReflectionAnalysis(analysis.reflections_by_unit, analysis.text_analysis);
}

// ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¡¨ç¤º
function displayInsights(insights) {
    const container = document.getElementById('insightsAnalysis');
    container.innerHTML = '';

    if (!insights || Object.keys(insights).length === 0) {
        container.innerHTML = '<p class="no-data">ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    for (const [unit, stage_insights] of Object.entries(insights)) {
        const predictionInsights = stage_insights.prediction || [];
        const reflectionInsights = stage_insights.reflection || [];
        
        const allInsights = predictionInsights.concat(reflectionInsights);
        
        if (allInsights.length === 0) continue;
        
        const html = `
            <div class="unit-insights">
                <h3>${unit}</h3>
                <div class="insights-list">
                    ${allInsights.map(insight => {
                        const icon = insight.includes('âœ“') ? 'âœ“' : 'â–³';
                        return `<div class="insight-item">${insight}</div>`;
                    }).join('')}
                </div>
            </div>
        `;
        container.innerHTML += html;
    }
}

// ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°çµæœã‚’è¡¨ç¤º
function displayClustering(clusteringData) {
    const container = document.getElementById('clusteringAnalysis');
    container.innerHTML = '';

    if (!clusteringData || Object.keys(clusteringData).length === 0) {
        container.innerHTML = '<p class="no-data">ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    for (const [unit, clustering] of Object.entries(clusteringData)) {
        if (!clustering || clustering.error) {
            continue;
        }

        const clusters = clustering.clusters || [];
        const clusterCount = clustering.cluster_count || 0;
        const diversityScore = clustering.diversity_score || 0;
        
        const html = `
            <div class="unit-clustering">
                <h3>${unit}</h3>
                <div class="clustering-info">
                    <div class="clustering-stat">
                        <label>ã‚¯ãƒ©ã‚¹ã‚¿æ•°:</label>
                        <span>${clusterCount}</span>
                    </div>
                    <div class="clustering-stat">
                        <label>å¤šæ§˜æ€§ã‚¹ã‚³ã‚¢:</label>
                        <span>${(diversityScore * 100).toFixed(1)}</span>
                    </div>
                </div>
                <div class="clusters-list">
                    ${clusters.map((cluster, idx) => `
                        <div class="cluster-item">
                            <h4>ã‚¯ãƒ©ã‚¹ã‚¿ ${idx + 1} (${cluster.size}ä»¶)</h4>
                            <div class="cluster-samples">
                                <strong>ä»£è¡¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong>
                                <p>${escapeHtml((cluster.representative || cluster.texts[0] || '').substring(0, 100))}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        container.innerHTML += html;
    }
}

// äºˆæƒ³æ®µéšã®åˆ†æã‚’è¡¨ç¤º
function displayPredictionAnalysis(predictionsByUnit, textAnalysis) {
    const container = document.getElementById('predictionAnalysis');
    container.innerHTML = '';

    if (Object.keys(predictionsByUnit).length === 0) {
        container.innerHTML = '<p class="no-data">äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    for (const [unit, predictions] of Object.entries(predictionsByUnit)) {
        const unitAnalysis = textAnalysis[unit]?.prediction || {};
        const html = `
            <div class="unit-analysis">
                <h3>${unit}</h3>
                <div class="analysis-metrics">
                    <div class="metric">
                        <label>å¯¾è©±æ•°:</label>
                        <span>${predictions.length}</span>
                    </div>
                    <div class="metric">
                        <label>å¹³å‡æ–‡å­—æ•°:</label>
                        <span>${Math.round(unitAnalysis.average_length || 0)}</span>
                    </div>
                    <div class="metric">
                        <label>æœ€å¤§æ–‡å­—æ•°:</label>
                        <span>${unitAnalysis.max_length || 0}</span>
                    </div>
                    <div class="metric science-metric">
                        <label>ç†ç§‘ç”¨èªå«æœ‰ç‡:</label>
                        <span>${(unitAnalysis.science_term_ratio || 0).toFixed(1)}%</span>
                    </div>
                </div>
                <div class="science-terms-section">
                    <h4>æ¤œå‡ºã•ã‚ŒãŸç†ç§‘ç”¨èª:</h4>
                    <div class="science-terms-list">
                        ${(unitAnalysis.science_terms || []).map(term =>
                            `<span class="science-term-tag">${term}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="keywords-section">
                    <h4>é »å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</h4>
                    <div class="keywords-list">
                        ${(unitAnalysis.keywords || []).map(kw =>
                            `<span class="keyword-tag">${kw.word} <small>(${kw.count})</small></span>`
                        ).join('')}
                    </div>
                </div>
                <div class="patterns-section">
                    <h4>è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³:</h4>
                    <ul class="patterns-list">
                        <li>äºˆæƒ³è¡¨ç¾: ${unitAnalysis.patterns?.prediction_expressions || 0}å›</li>
                        <li>å› æœè¡¨ç¾: ${unitAnalysis.patterns?.causal_expressions || 0}å›</li>
                        <li>æ¯”è¼ƒè¡¨ç¾: ${unitAnalysis.patterns?.comparison_expressions || 0}å›</li>
                        <li>çµŒé¨“å‚ç…§: ${unitAnalysis.patterns?.experience_references || 0}å›</li>
                        <li>ä¸ç¢ºå®Ÿæ€§è¡¨ç¾: ${unitAnalysis.patterns?.uncertainty_expressions || 0}å›</li>
                    </ul>
                </div>
                <details class="sample-messages">
                    <summary>ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹</summary>
                    <div class="messages-list">
                        ${predictions.slice(0, 5).map(p => `
                            <div class="message-item">
                                <div class="message-student">${p.student}</div>
                                <div class="message-text">
                                    <strong>å…ç«¥:</strong> ${escapeHtml(p.user_message)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `;
        container.innerHTML += html;
    }
}

// è€ƒå¯Ÿæ®µéšã®åˆ†æã‚’è¡¨ç¤º
function displayReflectionAnalysis(reflectionsByUnit, textAnalysis) {
    const container = document.getElementById('reflectionAnalysis');
    container.innerHTML = '';

    if (Object.keys(reflectionsByUnit).length === 0) {
        container.innerHTML = '<p class="no-data">è€ƒå¯Ÿãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    for (const [unit, reflections] of Object.entries(reflectionsByUnit)) {
        const unitAnalysis = textAnalysis[unit]?.reflection || {};
        const html = `
            <div class="unit-analysis">
                <h3>${unit}</h3>
                <div class="analysis-metrics">
                    <div class="metric">
                        <label>å¯¾è©±æ•°:</label>
                        <span>${reflections.length}</span>
                    </div>
                    <div class="metric">
                        <label>å¹³å‡æ–‡å­—æ•°:</label>
                        <span>${Math.round(unitAnalysis.average_length || 0)}</span>
                    </div>
                    <div class="metric">
                        <label>æœ€å¤§æ–‡å­—æ•°:</label>
                        <span>${unitAnalysis.max_length || 0}</span>
                    </div>
                    <div class="metric science-metric">
                        <label>ç†ç§‘ç”¨èªå«æœ‰ç‡:</label>
                        <span>${(unitAnalysis.science_term_ratio || 0).toFixed(1)}%</span>
                    </div>
                </div>
                <div class="science-terms-section">
                    <h4>æ¤œå‡ºã•ã‚ŒãŸç†ç§‘ç”¨èª:</h4>
                    <div class="science-terms-list">
                        ${(unitAnalysis.science_terms || []).map(term =>
                            `<span class="science-term-tag">${term}</span>`
                        ).join('')}
                    </div>
                </div>
                <div class="keywords-section">
                    <h4>é »å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</h4>
                    <div class="keywords-list">
                        ${(unitAnalysis.keywords || []).map(kw =>
                            `<span class="keyword-tag">${kw.word} <small>(${kw.count})</small></span>`
                        ).join('')}
                    </div>
                </div>
                <div class="patterns-section">
                    <h4>è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³:</h4>
                    <ul class="patterns-list">
                        <li>äºˆæƒ³è¡¨ç¾: ${unitAnalysis.patterns?.prediction_expressions || 0}å›</li>
                        <li>å› æœè¡¨ç¾: ${unitAnalysis.patterns?.causal_expressions || 0}å›</li>
                        <li>æ¯”è¼ƒè¡¨ç¾: ${unitAnalysis.patterns?.comparison_expressions || 0}å›</li>
                        <li>çµŒé¨“å‚ç…§: ${unitAnalysis.patterns?.experience_references || 0}å›</li>
                        <li>ä¸ç¢ºå®Ÿæ€§è¡¨ç¾: ${unitAnalysis.patterns?.uncertainty_expressions || 0}å›</li>
                    </ul>
                </div>
                <details class="sample-messages">
                    <summary>ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹</summary>
                    <div class="messages-list">
                        ${reflections.slice(0, 5).map(r => `
                            <div class="message-item">
                                <div class="message-student">${r.student}</div>
                                <div class="message-text">
                                    <strong>å…ç«¥:</strong> ${escapeHtml(r.user_message)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `;
        container.innerHTML += html;
    }
}

// HTMLç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<style>
.analysis-dashboard-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.analysis-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.analysis-header h1 {
    font-size: 2rem;
    margin: 0 0 10px 0;
}

.analysis-header p {
    margin: 0;
    opacity: 0.9;
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.analysis-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: 600;
    font-size: 0.9rem;
}

.filter-group select,
.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
}

/* æœŸé–“æŒ‡å®šã‚°ãƒ«ãƒ¼ãƒ—ã®è¡¨ç¤º/éè¡¨ç¤º */
#periodStartGroup, 
#periodEndGroup {
    display: none;
}

#periodStartGroup.visible,
#periodEndGroup.visible {
    display: flex;
}

/* çµ±è¨ˆæƒ…å ± */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    font-size: 2rem;
    color: #667eea;
}

.stat-content h3 {
    margin: 0 0 5px 0;
    font-size: 0.9rem;
    color: #666;
}

.stat-content p {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
    color: #333;
}

/* åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.analysis-section {
    margin-bottom: 30px;
}

.analysis-section h2 {
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.unit-analysis-container {
    display: grid;
    gap: 20px;
}

.unit-analysis {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
}

.unit-analysis h3 {
    margin-top: 0;
    color: #667eea;
}

/* ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */
.analysis-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.metric {
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
}

.metric label {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 5px;
}

.metric span {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}

/* ç†ç§‘ç”¨èªãƒ¡ãƒˆãƒªãƒƒã‚¯ */
.science-metric span {
    color: #e74c3c;
    font-weight: 700;
}

/* ç†ç§‘ç”¨èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.science-terms-section h4,
.keywords-section h4,
.patterns-section h4 {
    margin: 15px 0 10px 0;
    color: #333;
}

.science-terms-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.science-term-tag {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
}

/* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ */
.keywords-section h4,
.patterns-section h4 {
    margin: 15px 0 10px 0;
    color: #333;
}

.keywords-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.keyword-tag {
    background: #667eea;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
}

.keyword-tag small {
    margin-left: 4px;
    opacity: 0.8;
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³ */
.patterns-list {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}

.patterns-list li {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
}

.patterns-list li:last-child {
    border-bottom: none;
}

/* ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.sample-messages {
    margin-top: 15px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 4px;
    cursor: pointer;
}

.sample-messages summary {
    font-weight: 600;
    color: #667eea;
}

.messages-list {
    margin-top: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.message-item {
    padding: 10px;
    background: white;
    border-radius: 4px;
    margin-bottom: 10px;
    border-left: 3px solid #667eea;
}

.message-student {
    font-size: 0.8rem;
    color: #999;
    margin-bottom: 5px;
}

.message-text {
    font-size: 0.9rem;
    line-height: 1.5;
    word-break: break-word;
}

/* ãã®ä»– */
.no-data {
    text-align: center;
    padding: 30px;
    color: #999;
    background: #f9f9f9;
    border-radius: 4px;
}

.actions-section {
    text-align: center;
    margin-top: 30px;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 4px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: none;
    font-size: 1rem;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.insights-section {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.insights-section h2 {
    color: white;
    margin-top: 0;
}

.insights-container {
    display: grid;
    gap: 15px;
}

.unit-insights {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.unit-insights h3 {
    margin: 0 0 10px 0;
    color: #f5576c;
    font-size: 1.1rem;
}

.insights-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.insight-item {
    padding: 10px 12px;
    background: #f9f9f9;
    border-left: 4px solid #f5576c;
    border-radius: 4px;
    font-size: 0.95rem;
    line-height: 1.5;
}

.insight-item:contains("âœ“") {
    border-left-color: #27ae60;
    background: #f0fff4;
}

/* ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.clustering-container {
    display: grid;
    gap: 20px;
}

.unit-clustering {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
}

.unit-clustering h3 {
    margin-top: 0;
    color: #3498db;
}

.clustering-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.clustering-stat {
    padding: 10px;
    background: #ecf0f1;
    border-radius: 4px;
}

.clustering-stat label {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 5px;
    font-weight: 600;
}

.clustering-stat span {
    display: block;
    font-size: 1.3rem;
    font-weight: bold;
    color: #3498db;
}

.clusters-list {
    display: grid;
    gap: 15px;
}

.cluster-item {
    padding: 12px;
    background: #f8f9fa;
    border-left: 3px solid #3498db;
    border-radius: 4px;
}

.cluster-item h4 {
    margin: 0 0 8px 0;
    color: #2980b9;
    font-size: 0.95rem;
}

.cluster-samples {
    font-size: 0.85rem;
    line-height: 1.5;
}

.cluster-samples strong {
    color: #333;
}

.cluster-samples p {
    margin: 5px 0 0 0;
    padding: 8px;
    background: white;
    border-radius: 3px;
    color: #555;
    word-break: break-word;
}
</style>
{% endblock %}
