{% extends "base.html" %}

{% block title %}予想・考察分析{% endblock %}

{% block content %}
<div class="analysis-dashboard-page">
    <!-- ヘッダー -->
    <header class="analysis-header">
        <div class="header-container">
            <h1><i class="fas fa-microscope"></i> 予想・考察分析</h1>
            <p>児童の予想や関係付けの傾向を分析します</p>
        </div>
    </header>

    <!-- フィルターセクション -->
    <section class="analysis-filters">
        <div class="filter-group">
            <label for="unitSelect">単元選択:</label>
            <select id="unitSelect">
                <option value="">全単元</option>
                {% for unit in units %}
                <option value="{{ unit }}">{{ unit }}</option>
                {% endfor %}
            </select>
        </div>
        <button onclick="loadAnalysis()" class="btn btn-primary">分析を読み込む</button>
    </section>

    <!-- 分析結果 -->
    <section class="analysis-results">
        <!-- 統計情報 -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-comments"></i></div>
                <div class="stat-content">
                    <h3>総対話数</h3>
                    <p id="totalChats">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-lightbulb"></i></div>
                <div class="stat-content">
                    <h3>予想チャット</h3>
                    <p id="predictionCount">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                <div class="stat-content">
                    <h3>考察チャット</h3>
                    <p id="reflectionCount">0</p>
                </div>
            </div>
        </div>

        <!-- 単元別分析 -->
        <div class="analysis-content">
            <!-- 予想段階の分析 -->
            <div class="analysis-section">
                <h2><i class="fas fa-lightbulb"></i> 予想段階の分析</h2>
                <div id="predictionAnalysis" class="unit-analysis-container">
                    <!-- 単元ごとの分析がここに表示されます -->
                </div>
            </div>

            <!-- 考察段階の分析 -->
            <div class="analysis-section">
                <h2><i class="fas fa-graduation-cap"></i> 考察段階の分析</h2>
                <div id="reflectionAnalysis" class="unit-analysis-container">
                    <!-- 単元ごとの分析がここに表示されます -->
                </div>
            </div>
        </div>
    </section>

    <!-- 戻るボタン -->
    <div class="actions-section">
        <a href="/teacher/dashboard" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> ダッシュボードに戻る</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 初期化
document.addEventListener('DOMContentLoaded', function() {
    // サーバーから渡されたデータを使用
    const analysisData = {{ analysis_data | tojson | raw }};
    
    if (analysisData && analysisData.success) {
        displayAnalysis(analysisData);
    }
});

// 分析データを読み込む（フィルター変更時）
function loadAnalysis() {
    const unit = document.getElementById('unitSelect').value;
    // ページをリロード（新しい単元フィルタを適用）
    const url = `/teacher/analysis${unit ? '?unit=' + encodeURIComponent(unit) : ''}`;
    window.location.href = url;
}

// 分析結果を表示
function displayAnalysis(data) {
    // 統計情報を表示
    document.getElementById('totalChats').textContent = data.total_logs || 0;
    document.getElementById('predictionCount').textContent = data.prediction_chats || 0;
    document.getElementById('reflectionCount').textContent = data.reflection_chats || 0;

    // 学生分析結果を集計
    const studentAnalyses = data.student_analyses || {};
    
    if (Object.keys(studentAnalyses).length === 0) {
        document.getElementById('predictionAnalysis').innerHTML = '<p class="no-data">分析データがありません</p>';
        document.getElementById('reflectionAnalysis').innerHTML = '<p class="no-data">分析データがありません</p>';
        return;
    }

    // 予想・考察の集計
    const predictionsByUnit = {};
    const reflectionsByUnit = {};
    
    for (const [key, studentData] of Object.entries(studentAnalyses)) {
        const unit = studentData.unit;
        const analysis = studentData.analysis;
        
        if (!predictionsByUnit[unit]) {
            predictionsByUnit[unit] = [];
        }
        if (!reflectionsByUnit[unit]) {
            reflectionsByUnit[unit] = [];
        }
        
        // 予想情報を追加
        if (analysis.prediction_and_reflection && analysis.prediction_and_reflection.prediction.has_text) {
            predictionsByUnit[unit].push({
                student: `${studentData.class_num}組${studentData.seat_num}番`,
                analysis: analysis.prediction_and_reflection.prediction,
                overall_analysis: analysis
            });
        }
        
        // 考察情報を追加
        if (analysis.prediction_and_reflection && analysis.prediction_and_reflection.reflection.has_text) {
            reflectionsByUnit[unit].push({
                student: `${studentData.class_num}組${studentData.seat_num}番`,
                analysis: analysis.prediction_and_reflection.reflection,
                overall_analysis: analysis
            });
        }
    }

    // 表示
    displayPredictionAnalysis(predictionsByUnit);
    displayReflectionAnalysis(reflectionsByUnit);
}

// 予想段階の分析を表示
function displayPredictionAnalysis(predictionsByUnit) {
    const container = document.getElementById('predictionAnalysis');
    container.innerHTML = '';

    if (Object.keys(predictionsByUnit).length === 0) {
        container.innerHTML = '<p class="no-data">予想データがありません</p>';
        return;
    }

    for (const [unit, predictions] of Object.entries(predictionsByUnit)) {
        const avgClarityScore = predictions.reduce((sum, p) => sum + (p.analysis.basis_clarity || 0), 0) / predictions.length;
        const withExperience = predictions.filter(p => p.analysis.has_experience_reference).length;
        
        const html = `
            <div class="unit-analysis">
                <h3>${unit}</h3>
                <div class="analysis-metrics">
                    <div class="metric">
                        <label>児童数:</label>
                        <span>${predictions.length}</span>
                    </div>
                    <div class="metric">
                        <label>平均根拠度:</label>
                        <span>${avgClarityScore.toFixed(1)}/3</span>
                    </div>
                    <div class="metric">
                        <label>経験参照:</label>
                        <span>${withExperience}/${predictions.length}</span>
                    </div>
                </div>
                <div class="students-section">
                    <h4>児童別予想分析:</h4>
                    <div class="students-list">
                        ${predictions.map(p => `
                            <div class="student-analysis-item">
                                <strong>${p.student}</strong>
                                <ul style="font-size: 0.9rem;">
                                    <li>根拠度: ${p.analysis.basis_clarity || 0}/3</li>
                                    <li>経験参照: ${p.analysis.has_experience_reference ? 'あり' : 'なし'}</li>
                                    <li>テキスト長: ${p.analysis.text_length || 0}文字</li>
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    }
}

// 考察段階の分析を表示
function displayReflectionAnalysis(reflectionsByUnit) {
    const container = document.getElementById('reflectionAnalysis');
    container.innerHTML = '';

    if (Object.keys(reflectionsByUnit).length === 0) {
        container.innerHTML = '<p class="no-data">考察データがありません</p>';
        return;
    }

    for (const [unit, reflections] of Object.entries(reflectionsByUnit)) {
        const avgLinkingScore = reflections.reduce((sum, r) => sum + (r.analysis.linking_count || 0), 0) / reflections.length;
        const withExperimentLink = reflections.filter(r => r.analysis.experiment_link_count > 0).length;
        
        const html = `
            <div class="unit-analysis">
                <h3>${unit}</h3>
                <div class="analysis-metrics">
                    <div class="metric">
                        <label>児童数:</label>
                        <span>${reflections.length}</span>
                    </div>
                    <div class="metric">
                        <label>平均関係付け数:</label>
                        <span>${avgLinkingScore.toFixed(1)}</span>
                    </div>
                    <div class="metric">
                        <label>実験結果連結:</label>
                        <span>${withExperimentLink}/${reflections.length}</span>
                    </div>
                </div>
                <div class="students-section">
                    <h4>児童別考察分析:</h4>
                    <div class="students-list">
                        ${reflections.map(r => `
                            <div class="student-analysis-item">
                                <strong>${r.student}</strong>
                                <ul style="font-size: 0.9rem;">
                                    <li>関係付け数: ${r.analysis.linking_count || 0}</li>
                                    <li>実験連結: ${r.analysis.experiment_link_count > 0 ? 'あり' : 'なし'}</li>
                                    <li>一貫性: ${r.analysis.prediction_consistency || 'N/A'}</li>
                                    <li>テキスト長: ${r.analysis.text_length || 0}文字</li>
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    }
}

// HTML特殊文字をエスケープ
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<style>
.analysis-dashboard-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.analysis-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.analysis-header h1 {
    font-size: 2rem;
    margin: 0 0 10px 0;
}

.analysis-header p {
    margin: 0;
    opacity: 0.9;
}

/* フィルターセクション */
.analysis-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: 600;
    font-size: 0.9rem;
}

.filter-group select,
.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
}

/* 統計情報 */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    font-size: 2rem;
    color: #667eea;
}

.stat-content h3 {
    margin: 0 0 5px 0;
    font-size: 0.9rem;
    color: #666;
}

.stat-content p {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
    color: #333;
}

/* 分析セクション */
.analysis-section {
    margin-bottom: 30px;
}

.analysis-section h2 {
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.unit-analysis-container {
    display: grid;
    gap: 20px;
}

.unit-analysis {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
}

.unit-analysis h3 {
    margin-top: 0;
    color: #667eea;
}

/* メトリクス */
.analysis-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.metric {
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
}

.metric label {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 5px;
}

.metric span {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}

/* その他 */
.no-data {
    text-align: center;
    padding: 30px;
    color: #999;
    background: #f9f9f9;
    border-radius: 4px;
}

.actions-section {
    text-align: center;
    margin-top: 30px;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 4px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: none;
    font-size: 1rem;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* 学生一覧 */
.students-section {
    margin-top: 15px;
}

.students-section h4 {
    margin-bottom: 10px;
    color: #333;
    font-size: 0.95rem;
}

.students-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
}

.student-analysis-item {
    background: #f9f9f9;
    padding: 10px;
    border-radius: 4px;
    border-left: 3px solid #667eea;
}

.student-analysis-item strong {
    color: #333;
    display: block;
    margin-bottom: 8px;
}

.student-analysis-item ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.student-analysis-item li {
    padding: 3px 0;
    color: #555;
}
</style>
{% endblock %}
