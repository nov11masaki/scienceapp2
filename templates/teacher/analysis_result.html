{% extends "base.html" %}

{% block title %}å­¦ç¿’åˆ†æçµæœ{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-bar"></i> å­¦ç¿’åˆ†æçµæœ
                    </h4>
                    <small class="text-light">{{ class_num }}çµ„{{ seat_num }}ç•ª / {{ unit }}</small>
                </div>
                <div class="card-body">
                    <!-- ã‚µãƒãƒªãƒ¼ -->
                    <div class="alert alert-info">
                        <h6>ğŸ“Š ç·åˆè©•ä¾¡</h6>
                        <p class="mb-0">{{ analysis.summary }}</p>
                    </div>

                    <!-- äºˆæƒ³ãƒ»è€ƒå¯Ÿåˆ†æ -->
                    {% if analysis.prediction_and_reflection %}
                    <div class="card mb-4">
                        <div class="card-header bg-light border-bottom">
                            <h5 class="mb-0">
                                <i class="fas fa-lightbulb"></i> äºˆæƒ³ãƒ»è€ƒå¯Ÿåˆ†æ
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>ğŸ¯ ç·åˆã‚¹ã‚³ã‚¢</h6>
                                    <div class="progress" style="height: 25px;">
                                        {% set score_percent = (analysis.prediction_and_reflection.overall_score / analysis.prediction_and_reflection.max_score * 100) | int %}
                                        <div class="progress-bar {% if score_percent >= 70 %}bg-success{% elif score_percent >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ score_percent }}%;" 
                                             aria-valuenow="{{ score_percent }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ analysis.prediction_and_reflection.overall_score }}/{{ analysis.prediction_and_reflection.max_score }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- äºˆæƒ³ã®åˆ†æ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-header">
                                            <h6 class="mb-0">ğŸ“Œ äºˆæƒ³ã®åˆ†æ</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.prediction_and_reflection.prediction.has_text %}
                                                <p class="small text-muted">å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ:</p>
                                                <p class="card-text" style="font-size: 0.95rem; line-height: 1.6;">
                                                    {{ analysis.prediction_and_reflection.prediction.details.excerpt }}{% if analysis.prediction_and_reflection.prediction.text_length > 100 %}...{% endif %}
                                                </p>
                                                <hr>
                                                <ul class="list-unstyled">
                                                    <li><strong>æ ¹æ‹ ã®æ˜ç¢ºæ€§:</strong> 
                                                        <span class="badge {% if analysis.prediction_and_reflection.prediction.basis_clarity >= 2 %}bg-success{% elif analysis.prediction_and_reflection.prediction.basis_clarity == 1 %}bg-warning{% else %}bg-secondary{% endif %}">
                                                            {{ analysis.prediction_and_reflection.prediction.basis_clarity }}/3
                                                        </span>
                                                    </li>
                                                    <li><strong>å› æœãƒãƒ¼ã‚«ãƒ¼æ•°:</strong> {{ analysis.prediction_and_reflection.prediction.basis_count }}</li>
                                                    <li><strong>çµŒé¨“å‚ç…§:</strong> 
                                                        {% if analysis.prediction_and_reflection.prediction.has_experience_reference %}
                                                            <span class="badge bg-success">ã‚ã‚Š</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">ãªã—</span>
                                                        {% endif %}
                                                    </li>
                                                </ul>
                                            {% else %}
                                                <p class="text-muted small">äºˆæƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- è€ƒå¯Ÿã®åˆ†æ -->
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-header">
                                            <h6 class="mb-0">ğŸ’­ è€ƒå¯Ÿã®åˆ†æ</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.prediction_and_reflection.reflection.has_text %}
                                                <p class="small text-muted">å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ:</p>
                                                <p class="card-text" style="font-size: 0.95rem; line-height: 1.6;">
                                                    {{ analysis.prediction_and_reflection.reflection.details.excerpt }}{% if analysis.prediction_and_reflection.reflection.text_length > 100 %}...{% endif %}
                                                </p>
                                                <hr>
                                                <ul class="list-unstyled">
                                                    <li><strong>é–¢ä¿‚ä»˜ã‘æ•°:</strong> {{ analysis.prediction_and_reflection.reflection.linking_count }}</li>
                                                    <li><strong>å®Ÿé¨“çµæœã¨ã®çµã³ã¤ã:</strong>
                                                        {% if analysis.prediction_and_reflection.reflection.experiment_link_count > 0 %}
                                                            <span class="badge bg-success">{{ analysis.prediction_and_reflection.reflection.experiment_link_count }}å€‹</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">ãªã—</span>
                                                        {% endif %}
                                                    </li>
                                                    <li><strong>äºˆæƒ³ã¨ã®ä¸€è²«æ€§:</strong>
                                                        {% if analysis.prediction_and_reflection.reflection.prediction_consistency == 'consistent' %}
                                                            <span class="badge bg-success">ä¸€è²«ã—ã¦ã„ã‚‹</span>
                                                        {% elif analysis.prediction_and_reflection.reflection.prediction_consistency == 'partly_consistent' %}
                                                            <span class="badge bg-warning">éƒ¨åˆ†çš„ã«ä¸€è²«</span>
                                                        {% elif analysis.prediction_and_reflection.reflection.prediction_consistency == 'different' %}
                                                            <span class="badge bg-warning">ç•°ãªã‚‹</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">æœªç¢ºèª</span>
                                                        {% endif %}
                                                    </li>
                                                </ul>
                                            {% else %}
                                                <p class="text-muted small">è€ƒå¯Ÿãƒ†ã‚­ã‚¹ãƒˆãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- è§£é‡ˆ -->
                            <div class="alert alert-light border">
                                <h6 class="mb-2">ğŸ’¡ åˆ†æçµæœã®è§£é‡ˆ</h6>
                                <p class="mb-0">{{ analysis.prediction_and_reflection.interpretation }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- ä¼šè©±ãƒ™ãƒ¼ã‚¹åˆ†æçµæœ -->
                    <div class="card mb-4">
                        <div class="card-header bg-light border-bottom">
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i> ä¼šè©±åˆ†æï¼ˆ7è¦³ç‚¹ï¼‰
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- æ€è€ƒã®æ·±åŒ– -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6>
                                    <i class="fas fa-brain"></i> â‘  æ€è€ƒã®æ·±åŒ–
                                    <span class="badge bg-info float-end">
                                        {{ analysis.depth_of_thinking.self_corrections.count }} ä¿®æ­£ / 
                                        {{ analysis.depth_of_thinking.hesitations.count }} ãŸã‚ã‚‰ã„
                                    </span>
                                </h6>
                                <p class="small text-muted">è‡ªå·±ä¿®æ­£ã‚„ä»£æ›¿æ¡ˆã®æ¤œè¨ã‚’é€šã˜ã¦ã€æ€è€ƒã‚’æ·±ã‚ã‚‹éç¨‹</p>
                                {% if analysis.depth_of_thinking.self_corrections.count > 0 %}
                                    <div class="alert alert-success alert-sm py-2">
                                        <small>âœ“ {{ analysis.depth_of_thinking.self_corrections.count }}å›ã®è‡ªå·±ä¿®æ­£ã‚’ç¢ºèª</small>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- ç§‘å­¦èªå½™ -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6>
                                    <i class="fas fa-book"></i> â‘¡ ç§‘å­¦èªå½™ã®ç²å¾—
                                    <span class="badge bg-info float-end">
                                        {{ analysis.scientific_vocabulary.vocab_count }} èªå½™ / 
                                        {{ (analysis.scientific_vocabulary.infection_rate * 100) | int }}% æ„ŸæŸ“ç‡
                                    </span>
                                </h6>
                                <p class="small text-muted">å˜å…ƒã«é–¢é€£ã™ã‚‹ç§‘å­¦ç”¨èªã®ç¿’å¾—ç¨‹åº¦</p>
                                {% if analysis.scientific_vocabulary.infection_rate >= 0.3 %}
                                    <div class="alert alert-success alert-sm py-2">
                                        <small>âœ“ ç§‘å­¦èªå½™ã®æ„ŸæŸ“ç‡ãŒè‰¯å¥½ï¼ˆ{{ (analysis.scientific_vocabulary.infection_rate * 100) | int }}%ï¼‰</small>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6>
                                    <i class="fas fa-handshake"></i> â‘¢ ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ
                                    <span class="badge bg-info float-end">
                                        {{ analysis.engagement.turn_count }} å¾€å¾© / 
                                        {{ analysis.engagement.avg_user_length | round(1) }} å­—/å›
                                    </span>
                                </h6>
                                <p class="small text-muted">AI ã¨ã®å¯¾è©±ã‚’é€šã˜ãŸå‚åŠ åº¦ã¨ç™ºè©±ã®å……å®Ÿåº¦</p>
                            </div>

                            <!-- è«–ç†æ§‹é€  -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6>
                                    <i class="fas fa-sitemap"></i> â‘£ è«–ç†æ§‹é€ ã®å®šç€
                                    <span class="badge bg-info float-end">
                                        {{ analysis.structure_crystallization.qa_exchanges }} QA / 
                                        {{ analysis.structure_crystallization.multi_sentence_responses }}è¤‡æ–‡
                                    </span>
                                </h6>
                                <p class="small text-muted">è³ªå•ã«å¯¾ã™ã‚‹å•ç­”æ§‹é€ ã‚„å¤šæ®µéšçš„ãªèª¬æ˜ã®æ§‹ç¯‰</p>
                            </div>

                            <!-- æ ¹æ‹ çµ±åˆ -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6>
                                    <i class="fas fa-link"></i> â‘¤ æ ¹æ‹ ã®çµ±åˆ
                                    <span class="badge bg-info float-end">
                                        {{ analysis.evidence_integration.experience_mentions }} çµŒé¨“ / 
                                        {{ analysis.evidence_integration.evidence_keywords_count }} æ ¹æ‹ 
                                    </span>
                                </h6>
                                <p class="small text-muted">éå»ã®çµŒé¨“ã‚„å®Ÿé¨“çµæœã‚’æ ¹æ‹ ã¨ã—ã¦æ´»ç”¨ã™ã‚‹åŠ›</p>
                            </div>

                            <!-- ãƒ¡ã‚¿èªçŸ¥ -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6>
                                    <i class="fas fa-eye"></i> â‘¥ ãƒ¡ã‚¿èªçŸ¥
                                    <span class="badge bg-info float-end">
                                        {% if analysis.metacognition.has_metacognition %}
                                            ã‚ã‚Šï¼ˆ{{ analysis.metacognition.mention_count }}å›ï¼‰
                                        {% else %}
                                            ãªã—
                                        {% endif %}
                                    </span>
                                </h6>
                                <p class="small text-muted">è‡ªåˆ†ã®ç†è§£åº¦ã‚„å­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹ã‚’èªè­˜ã™ã‚‹åŠ›</p>
                            </div>

                            <!-- æ€è€ƒã®æ˜ç¢ºæ€§ -->
                            <div class="mb-4">
                                <h6>
                                    <i class="fas fa-lightbulb"></i> â‘¦ æ€è€ƒã®æ˜ç¢ºæ€§
                                    <span class="badge bg-info float-end">
                                        {{ analysis.thought_clarity.clarity_score }}/5
                                    </span>
                                </h6>
                                <p class="small text-muted">æ€è€ƒã‚’è¨€èªåŒ–ã™ã‚‹éš›ã®æ˜ç¢ºã•ã¨è¡¨ç¾ã®è³ª</p>
                            </div>
                        </div>
                    </div>

                    <!-- ä¼šè©±ãƒ­ã‚°ã‚µãƒãƒªãƒ¼ -->
                    <div class="card">
                        <div class="card-header bg-light border-bottom">
                            <h5 class="mb-0">
                                <i class="fas fa-history"></i> ä¼šè©±ãƒ­ã‚°ï¼ˆ{{ raw_log_count }}ä»¶ï¼‰
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-light">
                                <h6>ğŸ’¬ ä¼šè©±ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h6>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    {% for msg in conversation %}
                                        <div class="mb-3 pb-2 border-bottom" style="font-size: 0.95rem;">
                                            {% if msg.role == 'user' %}
                                                <span class="badge bg-primary">å…ç«¥</span>
                                            {% else %}
                                                <span class="badge bg-success">AI</span>
                                            {% endif %}
                                            <p class="mb-0 mt-2" style="line-height: 1.6;">
                                                {{ msg.content }}
                                            </p>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="text-center mt-4">
                <a href="/teacher/analysis_form" class="btn btn-primary">
                    <i class="fas fa-plus"></i> æ–°ã—ã„åˆ†æã‚’å®Ÿè¡Œ
                </a>
                <a href="/teacher/dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.alert-sm {
    padding: 0.25rem 0.75rem !important;
    margin: 0 !important;
}

.card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.badge {
    font-weight: 500;
}
</style>
{% endblock %}
