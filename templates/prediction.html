{% extends "base.html" %}

{% block title %}äºˆæƒ³ã‚’ç«‹ã¦ã‚ˆã†{% endblock %}

{% block content %}
<div class="chat-page-vertical">
    <div class="container-fluid h-100">
        <!-- ä¸ŠåŠåˆ†: å¯¾è©±ç”»é¢ -->
        <div class="chat-section">
            <div class="chat-header text-center mb-2">
                <h2 class="mb-2">
                    <i class="fas fa-brain text-primary"></i>
                    äºˆæƒ³ã‚’ç«‹ã¦ã‚ˆã†
                </h2>
                <div class="unit-display">
                    <span class="badge bg-primary fs-6">{{ unit }}</span>
                </div>
                <!-- ãƒœã‚¿ãƒ³ã‚’å³ä¸Šã«é…ç½® -->
                <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-sm" id="backToUnitHeaderButton" onclick="goBackToUnitSelection()">
                        <i class="fas fa-arrow-left me-2"></i>
                        å˜å…ƒé¸æŠã«æˆ»ã‚‹
                    </button>
                    <button class="btn btn-success btn-sm" id="summaryButton" onclick="getSummary()">
                        <i class="fas fa-check me-2"></i>
                        äºˆæƒ³ã‚’ã¾ã¨ã‚ã‚‹
                    </button>
                </div>
            </div>
            
            <div class="task-section mb-2">
                <div class="task-card">
                    <h5 class="task-title">
                        <i class="fas fa-clipboard-list"></i>
                        èª²é¡Œ
                    </h5>
                    <p class="task-content">{{ task_content }}</p>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="api-status" id="apiStatus" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="apiStatusMessage">AIæ¥ç¶šã‚’ç¢ºèªä¸­...</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="testApiConnection()">
                            <i class="fas fa-sync"></i> å†ãƒ†ã‚¹ãƒˆ
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        <div class="message-avatar"></div>
                        <div class="message-content">
                            {{ initial_ai_message }}
                        </div>
                    </div>
                    
                    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆç›´æ¥å…¥åŠ›å¯èƒ½ï¼‰ -->
                    <div class="message user-message user-input-area input-compact" style="margin-top: 12px;">
                        <div class="user-input-wrapper">
                            <div class="input-with-send">
                                <textarea class="user-input-bubble placeholder-input" id="messageInput" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                                <button class="send-button" id="sendButton" title="é€ä¿¡">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸è¦ãª action-buttons å‰Šé™¤ -->
            
            <div class="summary-section" id="summarySection" style="display: none;">
                <div class="summary-card">
                    <h5 class="summary-title">
                        <i class="fas fa-lightbulb"></i>
                        ã‚ãªãŸã®äºˆæƒ³
                    </h5>
                    <div class="summary-content" id="summaryContent"></div>
                    <!-- å˜å…ƒé¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼šäºˆæƒ³ã¾ã¨ã‚ã®ä¸‹ã«é…ç½® -->
                    <div class="text-center mt-3">
                        <button onclick="goBackToUnitSelection()" class="btn btn-primary btn-lg" id="backToUnitButton">
                            <i class="fas fa-arrow-left me-2"></i>
                            å˜å…ƒé¸æŠã«æˆ»ã‚‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸‹åŠåˆ†: å…¥åŠ›è£œåŠ©ã‚¨ãƒªã‚¢ -->
        <div class="input-assist-section" id="inputAssistSection">
            <div class="input-assist-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> å…¥åŠ›ã‚¨ãƒªã‚¢
                    </h5>
                    <div class="input-mode-switches">
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="toggle50on">
                            <label class="form-check-label" for="toggle50on">
                                50éŸ³è¡¨
                            </label>
                        </div>
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" id="toggleVoice">
                            <label class="form-check-label" for="toggleVoice">
                                éŸ³å£°å…¥åŠ›
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 50éŸ³è¡¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ -->
            <div class="keyboard-area-fullscreen" id="keyboardArea" style="display: none;">
                <div class="touch-keyboard-panel" id="touchKeyboard">
                    <div class="keyboard-grid-vertical" id="hiraganaKeys">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å…¥åŠ›ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="input-controls-area">
                <!-- éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ -->
                <div class="voice-input-section mb-2" id="voiceInputSection" style="display: none;">
                    <button class="btn btn-outline-primary w-100" id="voiceInputBtn">
                        <i class="fas fa-microphone"></i> éŸ³å£°ã§å…¥åŠ›
                    </button>
                    <div class="voice-input-status mt-2" id="voiceInputStatus" style="display: none;">
                        <div class="alert alert-info mb-0 py-2">
                            <i class="fas fa-microphone"></i>
                            <span id="voiceStatusText">éŸ³å£°ã‚’èªè­˜ä¸­...</span>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                <div class="d-flex gap-2">
                    <button class="btn btn-warning flex-fill" id="backspaceBtn">
                        <i class="fas fa-backspace"></i> æ¶ˆã™
                    </button>
                    <button class="btn btn-danger flex-fill" id="clearBtn">
                        <i class="fas fa-times"></i> å…¨æ¶ˆå»
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- äºˆæƒ³å®Œäº†æƒ…å ±ã‚’JSONã¨ã—ã¦åŸ‹ã‚è¾¼ã¿ -->
<script type="application/json" id="prediction-status">
{
    "prediction_summary_created": {{ prediction_summary_created | tojson | safe }},
    "predictionSummary": {{ session.get('prediction_summary', '') | tojson | safe }}
}
</script>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: éŸ³å£°èªè­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
let recognition = null;

let conversationCount = 0;
let lastMessage = '';

// äºˆæƒ³å®Œäº†çŠ¶æ…‹ã‚’å–å¾—
const predictionStatusElement = document.getElementById('prediction-status');
const predictionStatus = predictionStatusElement ? JSON.parse(predictionStatusElement.textContent) : {prediction_summary_created: false};

// URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
const urlParams = new URLSearchParams(window.location.search);
const classNumber = urlParams.get('class') || '1';
const studentNumber = urlParams.get('number') || '1';
const unit = urlParams.get('unit') || '';

function showPredictionSummaryButton(reason) {
    // ã¾ã¨ã‚ãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿éè¡¨ç¤º
    if (predictionStatus && predictionStatus.prediction_summary_created) return;
    const summaryButton = document.getElementById('summaryButton');
    if (!summaryButton) return;
    summaryButton.style.display = 'block';
    summaryButton.disabled = false;  // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    if (reason) {
        console.log('ã€DEBUGã€‘ã¾ã¨ã‚ãƒœã‚¿ãƒ³è¡¨ç¤º:', reason);
    }
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã¾ã¨ã‚ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æŠ¼ã›ã‚‹ã‚ˆã†ã«ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«');
    
    // localStorage ã‹ã‚‰ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒ
    const resume = new URLSearchParams(window.location.search).get('resume');
    if (resume !== 'false') {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒ
        restoreConversationFromLocalStorage();
    } else {
        // resume=false ã®å ´åˆ: localStorage ã‚’ã‚¯ãƒªã‚¢
        clearConversationLocalStorage();
    }
    
    // ã¾ã ã¾ã¨ã‚ãŒå®Œäº†ã—ã¦ã„ãªã„ãªã‚‰ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if (!predictionStatus || !predictionStatus.prediction_summary_created) {
        const summaryButton = document.getElementById('summaryButton');
        if (summaryButton) {
            summaryButton.style.display = 'block';
            summaryButton.disabled = false;
        }
    }
    
    // äºˆæƒ³ã®ã¾ã¨ã‚ãŒå®Œäº†ã—ã¦ã„ã‚Œã°å¾©å…ƒ
    if (predictionStatus && predictionStatus.prediction_summary_created) {
        console.log('äºˆæƒ³ã®ã¾ã¨ã‚ãŒå®Œäº†ã—ã¦ã„ã¾ã™');
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰äºˆæƒ³ã®ã¾ã¨ã‚ã‚’å–å¾—
        restorePredictionSummary();
    }
    
    testApiConnection();
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§50éŸ³è¡¨ãŒOFFãªã®ã§ã€å…¥åŠ›è£œåŠ©ã‚¨ãƒªã‚¢ã‚’ç¸®å°
    const inputAssistSection = document.getElementById('inputAssistSection');
    if (inputAssistSection) {
        inputAssistSection.classList.add('keyboard-off');
    }
    
    // å…¥åŠ›è£œåŠ©ã®åˆæœŸåŒ–
    initializeInputAssist();
    
    // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('input[name="inputMode"]').forEach(radio => {
        radio.addEventListener('change', switchInputMode);
    });
    
    // 50éŸ³è¡¨è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ
    const toggle50onSwitch = document.getElementById('toggle50on');
    if (toggle50onSwitch) {
        toggle50onSwitch.addEventListener('change', function() {
            const keyboardArea = document.getElementById('keyboardArea');
            const userInputArea = document.querySelector('.user-input-area');
            const inputAssistSection = document.getElementById('inputAssistSection');
            
            if (this.checked) {
                // 50éŸ³è¡¨ã‚’è¡¨ç¤º
                keyboardArea.style.display = 'flex';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-hidden', 'input-compact');
                    userInputArea.classList.add('keyboard-shown', 'input-normal');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-off');
                    inputAssistSection.classList.add('keyboard-on');
                }
            } else {
                // 50éŸ³è¡¨ã‚’éè¡¨ç¤ºï¼ˆå…¥åŠ›ã‚¨ãƒªã‚¢ä¸‹é™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + ç¸®å°ï¼‰
                keyboardArea.style.display = 'none';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-shown', 'input-normal');
                    userInputArea.classList.add('keyboard-hidden', 'input-compact');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-on');
                    inputAssistSection.classList.add('keyboard-off');
                }
            }
        });
    }
    
    // éŸ³å£°å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ
    const toggleVoiceSwitch = document.getElementById('toggleVoice');
    if (toggleVoiceSwitch) {
        toggleVoiceSwitch.addEventListener('change', function() {
            const voiceSection = document.getElementById('voiceInputSection');
            if (this.checked) {
                voiceSection.style.display = 'block';
            } else {
                voiceSection.style.display = 'none';
                stopVoiceInput(); // éŸ³å£°å…¥åŠ›ãŒæœ‰åŠ¹ãªå ´åˆã¯åœæ­¢
            }
        });
    }
    
    // éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    console.log('voiceInputBtnè¦ç´ :', voiceInputBtn);
    if (voiceInputBtn) {
        voiceInputBtn.addEventListener('click', function() {
            console.log('voiceInputBtnãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            startVoiceInput();
        });
        console.log('voiceInputBtnã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    } else {
        console.error('voiceInputBtnè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ç”¨ï¼‰
    const backspaceBtn = document.getElementById('backspaceBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    if (backspaceBtn) {
        backspaceBtn.addEventListener('click', function() {
            const input = document.getElementById('messageInput');
            if (input.value.length > 0) {
                input.value = input.value.slice(0, -1);
            }
            input.focus();
        });
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            const input = document.getElementById('messageInput');
            input.value = '';
            input.focus();
        });
    }
    
    // Enterã‚­ãƒ¼ã§é€ä¿¡
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ï¼‰
    const sendBtn = document.getElementById('sendButton');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆ50éŸ³è¡¨ã‚¨ãƒªã‚¢ï¼‰
    const inputAssistSendBtn = document.getElementById('inputAssistSendBtn');
    if (inputAssistSendBtn) {
        inputAssistSendBtn.addEventListener('click', sendMessage);
    }
    
    // ã¾ã¨ã‚ãƒœã‚¿ãƒ³
    const summaryBtn = document.getElementById('summaryButton');
    if (summaryBtn) {
        summaryBtn.addEventListener('click', getSummary);
    }
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼‰
let session = {
    'prediction_summary': ''
};

// å…¥åŠ›è£œåŠ©ç”¨ã®è¨­å®šï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã²ã‚‰ãŒãªã®ã¿ï¼‰
const inputAssistConfig = {
    hiragana: [
        // å³ã‹ã‚‰å·¦ã¸ã®ä¼çµ±çš„ãª50éŸ³è¡¨é…ç½®ï¼ˆç¸¦æ›¸ãï¼‰
        ['ã‚', 'ã‚‰', 'ã‚„', 'ã¾', 'ã¯', 'ãª', 'ãŸ', 'ã•', 'ã‹', 'ã‚'],
        ['', 'ã‚Š', '', 'ã¿', 'ã²', 'ã«', 'ã¡', 'ã—', 'ã', 'ã„'],
        ['ã‚’', 'ã‚‹', 'ã‚†', 'ã‚€', 'ãµ', 'ã¬', 'ã¤', 'ã™', 'ã', 'ã†'],
        ['', 'ã‚Œ', '', 'ã‚', 'ã¸', 'ã­', 'ã¦', 'ã›', 'ã‘', 'ãˆ'],
        ['ã‚“', 'ã‚', 'ã‚ˆ', 'ã‚‚', 'ã»', 'ã®', 'ã¨', 'ã', 'ã“', 'ãŠ'],
        // å°ã•ã„æ–‡å­—ã¨è¨˜å·ï¼ˆå·¦ã‹ã‚‰å³ã¸ï¼‰
        ['ã‚›ã‚œ', 'ã£', 'ã‚ƒ', 'ã‚…', 'ã‚‡', 'ã€', 'ã€‚', 'ï¼', 'ï¼Ÿ', 'ã‚¹ãƒšãƒ¼ã‚¹']
    ]
};

const currentUnit = "{{ unit }}";

// å…¥åŠ›è£œåŠ©ã®åˆæœŸåŒ–
function initializeInputAssist() {
    // ã²ã‚‰ãŒãªã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’è¨­å®šï¼ˆ10åˆ—ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€å³ã‹ã‚‰å·¦ï¼‰
    const hiraganaContainer = document.getElementById('hiraganaKeys');
    hiraganaContainer.innerHTML = '';
    
    inputAssistConfig.hiragana.forEach(row => {
        row.forEach(char => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary touch-key';
            if (char === '') {
                // ç©ºç™½ã‚»ãƒ«
                btn.style.visibility = 'hidden';
                btn.textContent = ' ';
            } else if (char === 'ã‚›ã‚œ') {
                // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ãƒœã‚¿ãƒ³
                btn.textContent = 'ã‚›ã‚œ';
                btn.className = 'btn btn-outline-secondary touch-key special-key';
                btn.onclick = () => addDakuten();
            } else if (char === 'ã‚¹ãƒšãƒ¼ã‚¹') {
                // ã‚¹ãƒšãƒ¼ã‚¹ãƒœã‚¿ãƒ³
                btn.textContent = 'ã‚¹ãƒšãƒ¼ã‚¹';
                btn.className = 'btn btn-outline-info touch-key space-key';
                btn.onclick = () => insertText(' ');
            } else if (char === 'ã€' || char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ') {
                // è¨˜å·ãƒœã‚¿ãƒ³
                btn.textContent = char;
                btn.className = 'btn btn-outline-secondary touch-key';
                btn.onclick = () => insertText(char);
            } else {
                // é€šå¸¸ã®ã²ã‚‰ãŒãªãƒœã‚¿ãƒ³
                btn.textContent = char;
                btn.onclick = () => insertText(char);
            }
            hiraganaContainer.appendChild(btn);
        });
    });
}

// æ¿ç‚¹ãƒ»åŠæ¿éŸ³ã‚’è¿½åŠ ï¼ˆå¾ªç’°å¯¾å¿œï¼‰
function addDakuten() {
    const input = document.getElementById('messageInput');
    const text = input.value;
    if (text.length === 0) return;
    
    const lastChar = text[text.length - 1];
    
    // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ã®å¾ªç’°ãƒãƒƒãƒ—ï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ åŠæ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
    const dakutenCycleMap = {
        // ã‹è¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ã‹': 'ãŒ', 'ãŒ': 'ã‹',
        'ã': 'ã', 'ã': 'ã',
        'ã': 'ã', 'ã': 'ã',
        'ã‘': 'ã’', 'ã’': 'ã‘',
        'ã“': 'ã”', 'ã”': 'ã“',
        // ã•è¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ã•': 'ã–', 'ã–': 'ã•',
        'ã—': 'ã˜', 'ã˜': 'ã—',
        'ã™': 'ãš', 'ãš': 'ã™',
        'ã›': 'ãœ', 'ãœ': 'ã›',
        'ã': 'ã', 'ã': 'ã',
        // ãŸè¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ãŸ': 'ã ', 'ã ': 'ãŸ',
        'ã¡': 'ã¢', 'ã¢': 'ã¡',
        'ã¤': 'ã¥', 'ã¥': 'ã¤',
        'ã¦': 'ã§', 'ã§': 'ã¦',
        'ã¨': 'ã©', 'ã©': 'ã¨',
        // ã¯è¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ åŠæ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ã¯': 'ã°', 'ã°': 'ã±', 'ã±': 'ã¯',
        'ã²': 'ã³', 'ã³': 'ã´', 'ã´': 'ã²',
        'ãµ': 'ã¶', 'ã¶': 'ã·', 'ã·': 'ãµ',
        'ã¸': 'ã¹', 'ã¹': 'ãº', 'ãº': 'ã¸',
        'ã»': 'ã¼', 'ã¼': 'ã½', 'ã½': 'ã»'
    };
    
    // å¾ªç’°ãƒãƒƒãƒ—ã«å­˜åœ¨ã™ã‚Œã°å¤‰æ›
    if (dakutenCycleMap[lastChar]) {
        input.value = text.slice(0, -1) + dakutenCycleMap[lastChar];
    }
    
    updateInputPreview();  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    input.focus();
}

// ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ï¼ˆ50éŸ³è¡¨ã‹ã‚‰ï¼‰
function insertText(text) {
    const input = document.getElementById('messageInput');
    input.value += text;
    input.focus();
}

// å…¥åŠ›è£œåŠ©ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function toggleInputAssist(enabled) {
    const keyboardDiv = document.getElementById('touchKeyboard');
    const voiceDiv = document.getElementById('voiceInputSection');
    
    if (enabled) {
        keyboardDiv.style.display = 'block';
        voiceDiv.style.display = 'block';
    } else {
        keyboardDiv.style.display = 'none';
        voiceDiv.style.display = 'none';
        stopVoiceInput();
    }
}

// éŸ³å£°å…¥åŠ›é–‹å§‹/åœæ­¢
function startVoiceInput() {
    console.log('éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    
    // æ—¢ã«èªè­˜ä¸­ãªã‚‰åœæ­¢
    if (recognition && recognition.isListening) {
        console.log('éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã™');
        stopVoiceInput();
        return;
    }
    
    // Web Speech API ã®ã‚µãƒãƒ¼ãƒˆç¢ºèª
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Edgeã€Safariã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
        console.error('Web Speech API not supported');
        return;
    }
    
    console.log('Web Speech API ã‚µãƒãƒ¼ãƒˆç¢ºèªOK');
    
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;  // ç¶™ç¶šçš„ã«èªè­˜
        recognition.interimResults = true;  // é€”ä¸­çµæœã‚‚å–å¾—
        
        console.log('SpeechRecognition ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†');
        
        const statusDiv = document.getElementById('voiceInputStatus');
        const statusText = document.getElementById('voiceStatusText');
        const voiceBtn = document.getElementById('voiceInputBtn');
        const input = document.getElementById('messageInput');
        
        // èªè­˜é–‹å§‹æ™‚ã®å…¥åŠ›æ¬„ã®ä½ç½®ã‚’è¨˜æ†¶
        let startPosition = 0;
        
        console.log('DOMè¦ç´ å–å¾—:', {statusDiv, statusText, voiceBtn});
        
        recognition.onstart = function() {
            console.log('éŸ³å£°èªè­˜é–‹å§‹');
            recognition.isListening = true;
            startPosition = input.value.length;  // ç¾åœ¨ã®å…¥åŠ›ä½ç½®ã‚’è¨˜æ†¶
            statusDiv.style.display = 'block';
            statusText.textContent = 'éŸ³å£°ã‚’èªè­˜ä¸­...';
            voiceBtn.innerHTML = '<i class="fas fa-stop"></i> åœæ­¢';
            voiceBtn.classList.add('btn-danger');
            voiceBtn.classList.remove('btn-outline-primary');
        };
        
        recognition.onresult = function(event) {
            console.log('ğŸ¤ onresult ã‚¤ãƒ™ãƒ³ãƒˆ:', {resultIndex: event.resultIndex, resultsLength: event.results.length});
            
            let interimTranscript = '';
            let finalTranscript = '';
            
            // å‰å›ã®ç¢ºå®šçµæœã‹ã‚‰ã®æ–°ã—ã„çµæœã®ã¿ã‚’å‡¦ç†
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                const isFinal = event.results[i].isFinal;
                const confidence = event.results[i][0].confidence;
                
                console.log(`çµæœ[${i}]:`, {transcript, isFinal, confidence});
                
                if (isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            
            // å…¥åŠ›æ¬„ã‚’æ›´æ–°ï¼ˆç¢ºå®šçµæœã®ã¿ã‚’è¿½åŠ ï¼‰
            if (finalTranscript.trim()) {
                console.log('âœ… ç¢ºå®šçµæœã‚’è¿½åŠ :', finalTranscript);
                // ç¢ºå®šã—ãŸçµæœã®ã¿ã‚’è¿½åŠ ï¼ˆä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼‰
                const cleanedFinalTranscript = finalTranscript.trim();
                input.value += cleanedFinalTranscript + ' ';
                console.log('å…¥åŠ›æ¬„ã®å†…å®¹:', input.value);
                startPosition = input.value.length;  // æ–°ã—ã„é–‹å§‹ä½ç½®ã‚’æ›´æ–°
                statusText.textContent = 'âœ… èªè­˜å®Œäº†: ' + cleanedFinalTranscript;
            }
            
            // é€”ä¸­çµæœã®è¡¨ç¤ºï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿ï¼‰
            if (interimTranscript) {
                statusText.textContent = 'ğŸ¤ èªè­˜ä¸­: ' + interimTranscript;
                console.log('é€”ä¸­çµæœ:', interimTranscript);
            }
            
            // å…¥åŠ›æ¬„ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«åˆã‚ã›ã‚‹
            input.focus();
            input.scrollTop = input.scrollHeight;
        };
        
        recognition.onerror = function(event) {
            console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
            statusDiv.style.display = 'none';
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> éŸ³å£°ã§å…¥åŠ›';
            voiceBtn.classList.remove('btn-danger');
            voiceBtn.classList.add('btn-outline-primary');
            recognition.isListening = false;
            
            if (event.error === 'no-speech') {
                alert('éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } else if (event.error === 'not-allowed') {
                alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else if (event.error !== 'aborted') {
                // aborted ã‚¨ãƒ©ãƒ¼ï¼ˆæ‰‹å‹•åœæ­¢ï¼‰ä»¥å¤–ã¯ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
                alert('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error);
            }
        };
        
        recognition.onend = function() {
            console.log('éŸ³å£°èªè­˜çµ‚äº†');
            statusDiv.style.display = 'none';
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> éŸ³å£°ã§å…¥åŠ›';
            voiceBtn.classList.remove('btn-danger');
            voiceBtn.classList.add('btn-outline-primary');
            recognition.isListening = false;
        };
        
        console.log('éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã™');
        recognition.start();
    } catch (error) {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
}

// éŸ³å£°å…¥åŠ›åœæ­¢
function stopVoiceInput() {
    console.log('éŸ³å£°å…¥åŠ›åœæ­¢');
    if (recognition && recognition.isListening) {
        recognition.stop();
        recognition.isListening = false;
    }
}

// localStorage ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
function saveConversationToLocalStorage(message, role) {
    try {
        const sessionKey = `conversation_${classNumber}_${studentNumber}_${unit}`;
        let history = JSON.parse(localStorage.getItem(sessionKey) || '[]');
        
        history.push({
            role: role,
            content: message,
            timestamp: new Date().toISOString()
        });
        
        localStorage.setItem(sessionKey, JSON.stringify(history));
        console.log('ã€DEBUGã€‘ä¼šè©±å±¥æ­´ã‚’ localStorage ã«ä¿å­˜:', sessionKey, history.length, 'messages');
    } catch (error) {
        console.error('ã€ERRORã€‘localStorage ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// localStorage ã‹ã‚‰ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒ
function restoreConversationFromLocalStorage() {
    try {
        const sessionKey = `conversation_${classNumber}_${studentNumber}_${unit}`;
        const history = JSON.parse(localStorage.getItem(sessionKey) || '[]');
        
        if (history.length === 0) {
            console.log('ã€DEBUGã€‘å¾©å…ƒã™ã‚‹ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        console.log('ã€DEBUGã€‘localStorage ã‹ã‚‰ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒ:', history.length, 'messages');
        
        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) {
            console.error('ã€ERRORã€‘chatMessages ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ï¼ˆå…¥åŠ›ã‚¨ãƒªã‚¢ã¯ä¿æŒï¼‰
        const inputArea = messagesContainer.querySelector('.user-input-area');
        messagesContainer.innerHTML = '';
        if (inputArea) {
            messagesContainer.appendChild(inputArea);
        }
        
        // å¾©å…ƒã•ã‚ŒãŸä¼šè©±å±¥æ­´ã‚’è¡¨ç¤º
        history.forEach((msg, index) => {
            const displayRole = msg.role === 'assistant' ? 'ai' : msg.role;
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã—ã§å¾©å…ƒï¼ˆé€Ÿåº¦é‡è¦–ï¼‰
            addMessage(msg.content, displayRole, false);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            if (msg.role === 'user') {
                conversationCount++;
            }
        });
        
        console.log('ã€DEBUGã€‘ä¼šè©±å±¥æ­´å¾©å…ƒå®Œäº†. conversationCount:', conversationCount);
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã«åŸºã¥ã„ã¦ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¤å®š
        const totalMessages = conversationCount * 2;
        if (totalMessages >= 6) {
            showPredictionSummaryButton('å¾©å…ƒæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ç¢ºèª');
        }
        
    } catch (error) {
        console.error('ã€ERRORã€‘localStorage å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
    }
}

// localStorage ã‹ã‚‰ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
function clearConversationLocalStorage() {
    try {
        const sessionKey = `conversation_${classNumber}_${studentNumber}_${unit}`;
        localStorage.removeItem(sessionKey);
        console.log('ã€DEBUGã€‘ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢:', sessionKey);
    } catch (error) {
        console.error('ã€ERRORã€‘localStorage ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
    }
}

function testApiConnection() {
    fetch('/api/test')
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('apiStatus');
        const messageSpan = document.getElementById('apiStatusMessage');
        
        if (data.status === 'success') {
            statusDiv.style.display = 'none';
            console.log('APIæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ:', data.response);
        } else {
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-danger';
            messageSpan.textContent = data.message || 'AIæ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™';
        }
    })
    .catch(error => {
        console.error('APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        const statusDiv = document.getElementById('apiStatus');
        const messageSpan = document.getElementById('apiStatusMessage');
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-danger';
        messageSpan.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™';
    });
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessage(message, 'user');
    input.value = '';
    
    // localStorage ã«ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
    saveConversationToLocalStorage(message, 'user');
    
    // APIã«é€ä¿¡
    sendMessageToAPI(message);
}

function addMessage(content, type, useTypingEffect = false) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);
    
    // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’å–å¾—
    const inputArea = document.querySelector('.user-input-area');
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    if (inputArea) {
        // å…¥åŠ›ã‚¨ãƒªã‚¢ã®å‰ã«è¿½åŠ ï¼ˆå…¥åŠ›ã‚¨ãƒªã‚¢ãŒæœ€å¾Œã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰
        messagesContainer.insertBefore(messageDiv, inputArea);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆAIå¿œç­”ã®ã¿ï¼‰
    if (useTypingEffect && type === 'ai') {
        typeMessage(contentDiv, content, messagesContainer);
    } else {
        contentDiv.innerHTML = content;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    return messageDiv; // ä½œæˆã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’è¿”ã™
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°
function typeMessage(element, text, container) {
    let index = 0;
    const speed = 30; // ãƒŸãƒªç§’å˜ä½ï¼ˆæ•°å€¤ãŒå°ã•ã„ã»ã©é€Ÿã„ï¼‰
    
    // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¿½åŠ 
    const cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    cursor.textContent = 'â–Œ';
    element.appendChild(cursor);
    
    function typeChar() {
        if (index < text.length) {
            // ã‚«ãƒ¼ã‚½ãƒ«ã®å‰ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
            const textNode = document.createTextNode(text.charAt(index));
            element.insertBefore(textNode, cursor);
            index++;
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            container.scrollTop = container.scrollHeight;
            
            setTimeout(typeChar, speed);
        } else {
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†å¾Œã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’å‰Šé™¤
            cursor.remove();
        }
    }
    
    typeChar();
}

function addRetryButton() {
    const messagesContainer = document.getElementById('chatMessages');
    const retryDiv = document.createElement('div');
    retryDiv.className = 'message ai-message retry-message';
    retryDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="message-content">
            <button class="btn btn-outline-primary btn-sm" onclick="retryLastMessage()">
                <i class="fas fa-redo me-2"></i>å†è©¦è¡Œ
            </button>
        </div>
    `;
    
    // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’å–å¾—
    const inputArea = document.querySelector('.user-input-area');
    
    if (inputArea) {
        // å…¥åŠ›ã‚¨ãƒªã‚¢ã®å‰ã«è¿½åŠ 
        messagesContainer.insertBefore(retryDiv, inputArea);
    } else {
        messagesContainer.appendChild(retryDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function retryLastMessage() {
    // å†è©¦è¡Œãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
    const retryMessages = document.querySelectorAll('.retry-message');
    retryMessages.forEach(msg => msg.remove());
    
    // æœ€å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†é€ä¿¡
    const userMessages = document.querySelectorAll('.user-message .message-content');
    if (userMessages.length > 0) {
        const lastMessage = userMessages[userMessages.length - 1].textContent;
        // ç›´æ¥APIã‚’å‘¼ã³å‡ºã™
        sendMessageToAPI(lastMessage);
    }
}

function sendMessageToAPI(message) {
    console.log('ã€DEBUGã€‘sendMessageToAPI å‘¼ã³å‡ºã—, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message);
    
    // èª­ã¿è¾¼ã¿ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    const loadingMessage = addMessage('è€ƒãˆä¸­...', 'ai');
    loadingMessage.classList.add('loading-message');
    
    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    const requestData = { 
        message: message
    };
    
    console.log('ã€DEBUGã€‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', requestData);
    
    // AIã®å¿œç­”ã‚’å–å¾—
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('ã€DEBUGã€‘ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
        
        // èª­ã¿è¾¼ã¿ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const loadingMessages = document.querySelectorAll('.loading-message');
        loadingMessages.forEach(msg => msg.remove());
        
        if (!response.ok) {
            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('ã€DEBUGã€‘JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
        
        if (data.error) {
            console.error('ã€DEBUGã€‘ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data.error);
            addMessage('âš ï¸ ' + data.error, 'ai', false);
            addRetryButton();
        } else {
            console.log('ã€DEBUGã€‘AIè¿”ç­”ã‚’è¡¨ç¤º:', data.response);
            addMessage(data.response, 'ai', true); // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæœ‰åŠ¹
            // localStorage ã« AI å¿œç­”ã‚‚ä¿å­˜
            saveConversationToLocalStorage(data.response, 'assistant');
            conversationCount++;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå¾€å¾©æ•° * 2 ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·æ•°ã‚’ç®—å‡ºï¼‰
            const totalMessages = conversationCount * 2;
            
            // 6ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥ä¸Šã¾ãŸã¯AIãŒã€Œã¾ã¨ã‚ã€ã‚’ä¿ƒã—ãŸã‚‰è¦ç´„ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            if (totalMessages >= 6 || data.suggest_summary || data.response.includes('ã¾ã¨ã‚') || data.response.includes('è¦ç´„')) {
                showPredictionSummaryButton(`ä¼šè©±æ•°:${totalMessages}/${6} / suggest:${data.suggest_summary}`);
            }
            
            // ãƒ‡ã‚¸ã‚¿ãƒ«å­¦ç¿’ãƒ„ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
            if (data.twin_insights && window.location.hostname === 'localhost') {
                console.log('å­¦ç¿’ãƒ„ã‚¤ãƒ³åˆ†æ:', data.twin_insights);
                displayTwinInsights(data.twin_insights);
            }
            
            // ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«åŒæœŸï¼ˆå®šæœŸçš„ã«è‡ªå‹•ä¿å­˜ï¼‰
            syncSessionData('prediction');
        }
    })
    .catch(error => {
        // èª­ã¿è¾¼ã¿ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const loadingMessages = document.querySelectorAll('.loading-message');
        loadingMessages.forEach(msg => msg.remove());
        
        console.error('ã€DEBUGã€‘ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒ:', error);
        console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        addMessage('âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'ai', false);
        addRetryButton();
        
        // APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        testApiConnection();
    });
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«åŒæœŸï¼ˆGCS/ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
function syncSessionData(stage) {
    try {
        const chatMessages = getChatMessages();
        const studentId = `${classNumber}_${studentNumber}`;
        const summaryContent = document.getElementById('summaryContent')?.innerHTML || '';
        
        const syncData = {
            student_id: studentId,
            unit: unit,
            stage: stage,
            chat_messages: chatMessages,
            summary_content: summaryContent
        };
        
        fetch('/api/sync-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(syncData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('[SYNC] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæœŸã—ã¾ã—ãŸ:', data.message);
            } else {
                console.warn('[SYNC] åŒæœŸã‚¨ãƒ©ãƒ¼:', data.error);
            }
        })
        .catch(error => {
            console.warn('[SYNC] åŒæœŸå¤±æ•—:', error);
        });
    } catch (error) {
        console.warn('[SYNC] ã‚»ãƒƒã‚·ãƒ§ãƒ³åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é…åˆ—å½¢å¼ã§å–å¾—
function getChatMessages() {
    const messages = [];
    const messageElements = document.querySelectorAll('#chatMessages .message');
    
    messageElements.forEach(element => {
        const isUser = element.classList.contains('user-message');
        const isAi = element.classList.contains('ai-message');
        const contentDiv = element.querySelector('.message-content');
        
        if (contentDiv && (isUser || isAi)) {
            messages.push({
                role: isUser ? 'user' : 'assistant',
                content: contentDiv.textContent
            });
        }
    });
    
    return messages;
}

// è¦ç´„ãŒå®Ÿè³ªçš„ãªæ„å‘³ã‚’æŒã¤ã‹ãƒã‚§ãƒƒã‚¯
function isMeaningfulSummary(summary) {
    if (!summary || summary.trim().length < 15) return false;
    
    // ç„¡æ„å‘³ãªé€£ç¶šæ–‡å­—ï¼ˆè¨˜å·ã‚„åŒã˜æ–‡å­—ã®ç¹°ã‚Šè¿”ã—ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
    const meaninglessPatterns = /([ãƒ´ã‚¡slmv]{2,}|[ããƒã…ã‡ã‰]{3,}|~~~|~~~|\.\.\.|ã€ã€|ã€‘ã€‘)/g;
    const meaninglessMatches = (summary.match(meaninglessPatterns) || []).length;
    
    // ç„¡æ„å‘³ãªæ–‡å­—åˆ—ã®å‰²åˆãŒé«˜ã„å ´åˆã¯NG
    if (meaninglessMatches > 0) {
        const totalWords = summary.split(/[\sã€ã€‚]/g).length;
        if (meaninglessMatches / totalWords > 0.3) {
            return false;
        }
    }
    
    // å®Ÿéš›ã®å®Ÿé¨“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„å…ç«¥ã®æ€è€ƒã‚’å«ã‚“ã§ã„ã‚‹ã‹
    const hasValidContent = /(?:å…ç«¥|è€ƒãˆ|æ€ã†|äºˆæƒ³|æ°—ã¥|ã‚ã‹ã£|è©¦ã™|è¦³å¯Ÿ|æ¸©åº¦|ã‚ãŸãŸã¾ã‚Š|å¤‰ã‚)/i.test(summary);
    
    return hasValidContent;
}

function getSummary() {
    console.log('ã€DEBUGã€‘getSummary å‘¼ã³å‡ºã—');
    
    const summaryButton = document.getElementById('summaryButton');
    
    // ãƒœã‚¿ãƒ³ãŒæ—¢ã«ç„¡åŠ¹ãªå ´åˆã¯äºŒé‡å®Ÿè¡Œã‚’é˜²æ­¢
    if (summaryButton.disabled) {
        console.log('ã€DEBUGã€‘æ—¢ã«ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚äºŒé‡å®Ÿè¡Œã‚’é˜²æ­¢ã—ã¾ã™ã€‚');
        return;
    }
    
    // æ—¢ã«è¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç¢ºèªã‚’å–ã‚‹
    console.log('ã€DEBUGã€‘ãƒœã‚¿ãƒ³è¡¨ç¤ºçŠ¶æ…‹:', summaryButton.style.display);
    if (summaryButton.style.display === 'none') {
        console.log('ã€DEBUGã€‘ãƒœã‚¿ãƒ³ãŒéè¡¨ç¤ºãªã®ã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™');
        const confirmed = confirm('ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ\n\nå‰ã®äºˆæƒ³ã¯ä¿å­˜ã•ã‚Œã¾ã™ã€‚\n\nã„ã„ã§ã™ã‹ï¼Ÿ');
        if (!confirmed) {
            return;
        }
        // ç¢ºèªå¾Œã€æ–°ã—ã„ä¼šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        // resume=false ã§æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        const urlParams = new URLSearchParams(window.location.search);
        const classNum = urlParams.get('class');
        const studentNum = urlParams.get('number');
        const unit = urlParams.get('unit');
        window.location.href = `/prediction?class=${classNum}&number=${studentNum}&unit=${unit}&resume=false`;
        return;
    }
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    summaryButton.disabled = true;
    
    fetch('/summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('ã€DEBUGã€‘/summary ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
        return response.json().then(data => {
            if (!response.ok) {
                // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ400ãªã©ï¼‰
                if (data.error) {
                    throw new Error(data.error);
                }
                throw new Error(`HTTP ${response.status}`);
            }
            return data;
        });
    })
    .then(data => {
        console.log('ã€DEBUGã€‘è¦ç´„ãƒ‡ãƒ¼ã‚¿:', data);
        if (data.error) {
            alert('ã¾ã¨ã‚ã‚‰ã‚Œã¾ã›ã‚“ï¼š' + data.error);
            document.getElementById('summaryButton').disabled = false;
            return;
        }
        
        console.log('ã€DEBUGã€‘è¦ç´„ã‚’è¡¨ç¤ºã—ã¾ã™:', data.summary);
        
        // è¦ç´„ãŒæœ‰åŠ¹ãªå†…å®¹ã‹ç¢ºèª
        if (!isMeaningfulSummary(data.summary)) {
            alert('ã‚‚ã£ã¨ã€ã„ã£ã±ã„å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            document.getElementById('summaryButton').disabled = false;
            return;
        }
        
        // ãƒãƒ£ãƒƒãƒˆã«AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¦ç´„ã‚’è¿½åŠ 
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        messageDiv.innerHTML = `
            <div class="message-avatar"></div>
            <div class="message-content">${data.summary}</div>
        `;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚¨ãƒªã‚¢ã®ç›´å‰ã«æŒ¿å…¥
        const userInputArea = messagesContainer.querySelector('.user-input-area');
        if (userInputArea) {
            userInputArea.parentNode.insertBefore(messageDiv, userInputArea);
        } else {
            messagesContainer.appendChild(messageDiv);
        }
        
        // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
        if (userInputArea) {
            userInputArea.style.display = 'none';
        }
        
        // ã¾ã¨ã‚ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºï¼ˆå˜å…ƒé¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºã—ãŸã¾ã¾ï¼‰
        document.getElementById('summaryButton').style.display = 'none';
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);
        
        // è¦ç´„å¾Œã®çŠ¶æ…‹ã‚’ä¿å­˜
        session['prediction_summary'] = data.summary;
        
        // ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’è¡¨ç¤º
        const summarySection = document.getElementById('summarySection');
        if (summarySection) {
            summarySection.style.display = 'block';
            console.log('ã€DEBUGã€‘summarySection ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // ãƒãƒ£ãƒƒãƒˆæœ¬ä½“ã®ã¿éè¡¨ç¤ºã«ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹
        const chatContainer = document.querySelector('.chat-container');
        if (chatContainer) {
            chatContainer.style.display = 'none';
            console.log('ã€DEBUGã€‘chat-container ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
        }
        
        // èª²é¡Œã‚«ãƒ¼ãƒ‰ã‚‚éš ã™ï¼ˆã¾ã¨ã‚è¡¨ç¤ºã‚’å¼·èª¿ï¼‰
        const taskSection = document.querySelector('.task-section');
        if (taskSection) {
            taskSection.style.display = 'none';
            console.log('ã€DEBUGã€‘task-section ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
        }
        
        // å…¥åŠ›è£œåŠ©ã‚¨ãƒªã‚¢ã‚‚éè¡¨ç¤º
        const inputAssist = document.getElementById('inputAssistSection');
        if (inputAssist) {
            inputAssist.style.display = 'none';
            console.log('ã€DEBUGã€‘inputAssistSection ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
        }
        
        // ã‚µãƒãƒªãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¦ç´„ã‚’è¨­å®š
        const summaryContent = document.getElementById('summaryContent');
        if (summaryContent) {
            summaryContent.innerHTML = data.summary.replace(/\n/g, '<br>');
            console.log('ã€DEBUGã€‘summaryContent ã«è¦ç´„ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }
        
        // å˜å…ƒé¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆè¦ç´„æˆåŠŸæ™‚ã®ã¿ï¼‰
        const backButton = document.getElementById('backToUnitButton');
        console.log('ã€DEBUGã€‘backToUnitButton:', backButton);
        if (backButton) {
            backButton.style.display = 'inline-block';
            console.log('ã€DEBUGã€‘å˜å…ƒé¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            setTimeout(() => {
                backButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 500);
        }
    })
    .catch(error => {
        console.error('ã€DEBUGã€‘Summary Error:', error);
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è­¦å‘Šã‚’è¡¨ç¤º
        alert('äºˆæƒ³ã‚’ã¾ã¨ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nã‚‚ã†ä¸€åº¦ã‚„ã£ã¦ã¿ã¦ãã ã•ã„ã€‚');
        document.getElementById('summaryButton').disabled = false;
    });
}

// å˜å…ƒé¸æŠã«æˆ»ã‚‹
function goBackToUnitSelection() {
    // ã¾ã¨ã‚ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰ï¼ˆã¾ã¨ã‚ã¦ã„ãªã‹ã£ãŸã‚‰ï¼‰è­¦å‘Š
    const summaryButton = document.getElementById('summaryButton');
    if (summaryButton && summaryButton.style.display !== 'none') {
        const confirmed = confirm('äºˆæƒ³ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã›ã‚“ã€‚\n\næˆ»ã‚‹ã¨ã€ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã•ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚\n\nã„ã„ã§ã™ã‹ï¼Ÿ');
        if (!confirmed) {
            return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰æˆ»ã‚‰ãªã„
        }
    }
    window.location.href = `/select_unit?class=${classNumber}&number=${studentNumber}`;
}

// å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
function switchInputMode() {
    const mode = document.querySelector('input[name="inputMode"]:checked').id;
    const toggleSwitch = document.getElementById('toggleInputAssist');
    
    const touchKeyboard = document.getElementById('touchKeyboard');
    const keyboardArea = document.getElementById('keyboardArea');
    
    if (mode === 'modeKeyboard') {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§ã¯50éŸ³è¡¨ã‚’éè¡¨ç¤º
        keyboardArea.style.display = 'none';
        toggleSwitch.checked = false;
    } else if (mode === 'mode50on') {
        // 50éŸ³è¡¨ãƒ¢ãƒ¼ãƒ‰
        touchKeyboard.style.display = 'block';
        keyboardArea.style.display = 'block';
        toggleSwitch.checked = true;
    }
}

// å¾©å¸°æ™‚ã«éå»ã®ä¼šè©±ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
// å¾©å¸°æ™‚ã«äºˆæƒ³ã®ã¾ã¨ã‚ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
function restorePredictionSummary() {
    console.log('restorePredictionSummary: äºˆæƒ³ã®ã¾ã¨ã‚ã‚’å¾©å…ƒä¸­...');
}

// ã‚¨ãƒ©ãƒ¼å ±å‘Šé–¢æ•°
function reportError(errorMessage, errorType = 'client_error', additionalInfo = {}) {
    const stage = '{{ session.get("current_stage", "prediction") }}';
    const unit = '{{ session.get("unit", "") }}';
    
    console.error(`[ERROR REPORT] ${errorType}: ${errorMessage}`);
    
    fetch('/report_error', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            error_message: errorMessage,
            error_type: errorType,
            stage: stage,
            unit: unit,
            additional_info: additionalInfo
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[ERROR REPORT] Success:', data);
    })
    .catch(error => {
        console.error('[ERROR REPORT] Failed:', error);
    });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
window.addEventListener('error', (event) => {
    const errorMessage = event.message || 'Unknown error';
    const errorSource = event.filename || 'unknown';
    const errorLine = event.lineno || 'unknown';
    
    reportError(`${errorMessage} (${errorSource}:${errorLine})`, 'javascript_error', {
        filename: errorSource,
        lineno: errorLine,
        colno: event.colno
    });
});

// Promise ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
window.addEventListener('unhandledrejection', (event) => {
    const errorMessage = event.reason ? String(event.reason) : 'Unknown promise rejection';
    reportError(errorMessage, 'promise_error', {
        reason: event.reason
    });
});

</script>
{% endblock %}

