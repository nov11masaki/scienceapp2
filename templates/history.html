{% extends "base.html" %}

{% block title %}å­¦ç¿’å±¥æ­´{% endblock %}

{% block content %}
<div class="history-page">
    <div class="container mt-4">
        <div class="text-center mb-4">
            <div class="class-info-banner mb-3">
                <span class="class-badge">ï¼”å¹´<span id="selectedClass"></span>çµ„ <span id="selectedNumber"></span>ç•ª</span>
            </div>
            <h2 class="mb-3">
                <i class="fas fa-history text-primary"></i>
                å­¦ç¿’å±¥æ­´
            </h2>
            <p class="text-muted">ã“ã‚Œã¾ã§ã®äºˆæƒ³ã¨è€ƒå¯Ÿã‚’ç¢ºèªã§ãã¾ã™</p>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div id="history-container">
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-5">
            <a href="#" onclick="goBack()" class="btn btn-outline-secondary me-3">
                <i class="fas fa-arrow-left me-2"></i>å˜å…ƒé¸æŠã«æˆ»ã‚‹
            </a>
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-home me-2"></i>æœ€åˆã«æˆ»ã‚‹
            </a>
        </div>
    </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<style>
    .history-page {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }

    .unit-history-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .unit-history-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .unit-title {
        color: #333;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1.2rem;
    }

    .stage-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .stage-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .stage-badge-prediction {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        color: #1976d2;
    }

    .stage-badge-prediction:hover {
        background-color: #bbdefb;
        transform: translateY(-2px);
    }

    .stage-badge-reflection {
        background-color: #f3e5f5;
        border-left: 4px solid #9c27b0;
        color: #7b1fa2;
    }

    .stage-badge-reflection:hover {
        background-color: #e1bee7;
        transform: translateY(-2px);
    }

    .no-data {
        padding: 30px;
        text-align: center;
        color: #999;
    }

    .summary-text {
        background: #f9f9f9;
        padding: 15px;
        border-left: 4px solid #2196f3;
        border-radius: 4px;
        margin: 10px 0;
        line-height: 1.6;
    }

    .summary-meta {
        font-size: 0.85rem;
        color: #666;
        margin-top: 10px;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
// URLã‹ã‚‰ã‚¯ãƒ©ã‚¹ç•ªå·ã¨å‡ºå¸­ç•ªå·ã‚’å–å¾—
const urlParams = new URLSearchParams(window.location.search);
const classNumber = urlParams.get('class') || '1';
const studentNumber = urlParams.get('number') || '1';

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
let historyData = {};

// ã‚¯ãƒ©ã‚¹ç•ªå·ã¨å‡ºå¸­ç•ªå·ã‚’è¡¨ç¤º
document.getElementById('selectedClass').textContent = classNumber;
document.getElementById('selectedNumber').textContent = studentNumber;

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å±¥æ­´ã‚’å–å¾—
document.addEventListener('DOMContentLoaded', loadHistory);

async function loadHistory() {
    try {
        const response = await fetch(`/api/student-history?class=${classNumber}&number=${studentNumber}`);
        historyData = await response.json();
        
        displayHistory(historyData);
    } catch (error) {
        console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        document.getElementById('history-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ
            </div>
        `;
    }
}

function displayHistory(history) {
    const container = document.getElementById('history-container');
    
    if (!history || Object.keys(history).length === 0) {
        container.innerHTML = `
            <div class="no-data">
                <i class="fas fa-inbox" style="font-size: 2rem; color: #ddd; margin-bottom: 10px;"></i>
                <p>ã¾ã å­¦ç¿’å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        `;
        return;
    }

    let html = '';

    for (const [unit, stages] of Object.entries(history)) {
        html += `
            <div class="unit-history-card">
                <div class="unit-title">
                    <i class="fas fa-book"></i> ${unit}
                </div>
                <div class="stage-container">
        `;

        if (stages.prediction) {
            const predData = stages.prediction;
            const savedDate = new Date(predData.saved_at).toLocaleString('ja-JP');
            const dataKey = `${unit}_prediction`;
            
            html += `
                <div class="stage-badge stage-badge-prediction" 
                     onclick="showDetail('${dataKey}')">
                    <i class="fas fa-lightbulb"></i>
                    <span>äºˆæƒ³</span>
                    <small style="opacity: 0.7;">${savedDate.split(' ')[0]}</small>
                </div>
            `;
        }

        if (stages.reflection) {
            const reflData = stages.reflection;
            const savedDate = new Date(reflData.saved_at).toLocaleString('ja-JP');
            const dataKey = `${unit}_reflection`;
            
            html += `
                <div class="stage-badge stage-badge-reflection"
                     onclick="showDetail('${dataKey}')">
                    <i class="fas fa-comments"></i>
                    <span>è€ƒå¯Ÿ</span>
                    <small style="opacity: 0.7;">${savedDate.split(' ')[0]}</small>
                </div>
            `;
        }

        html += `
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

function showDetail(dataKey) {
    const [unit, stage] = dataKey.split('_');
    const data = historyData[unit] && historyData[unit][stage];
    
    if (!data) {
        alert('è©³ç´°ã‚’å–å¾—ã§ãã¾ã›ã‚“');
        return;
    }
    
    const title = `${unit} - ${stage === 'prediction' ? 'äºˆæƒ³' : 'è€ƒå¯Ÿ'}`;
    const summary = data.summary || 'ï¼ˆå†…å®¹ãªã—ï¼‰';
    const savedDate = new Date(data.saved_at).toLocaleString('ja-JP');
    const conversation = data.conversation || [];
    
    let bodyContent = `
        <div class="mb-3">
            <h6 class="text-muted">ä¿å­˜æ—¥æ™‚</h6>
            <p>${savedDate}</p>
        </div>
        <div class="mb-3">
            <h6 class="text-muted">å†…å®¹</h6>
            <div class="summary-text">
                ${escapeHtml(summary)}
            </div>
        </div>
    `;
    
    // ä¼šè©±ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
    if (conversation.length > 0) {
        bodyContent += `
            <div class="mt-4">
                <h6 class="text-muted">ãã®æ™‚ã®ä¼šè©±</h6>
                <div class="conversation-history" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 12px; border-radius: 4px;">
        `;
        
        conversation.forEach((msg, index) => {
            const isAssistant = msg.role === 'assistant';
            const messageClass = isAssistant ? 'assistant-message' : 'user-message';
            const icon = isAssistant ? 'ğŸ¤–' : 'ğŸ‘§';
            
            bodyContent += `
                <div style="margin-bottom: 10px;">
                    <strong style="color: ${isAssistant ? '#0066cc' : '#666666'};">${icon} ${isAssistant ? 'å…ˆç”Ÿ' : 'è‡ªåˆ†'}</strong>
                    <div style="background-color: ${isAssistant ? '#e8f4f8' : '#fff9e6'}; padding: 8px 12px; border-radius: 4px; margin-top: 4px; word-break: break-word;">
                        ${escapeHtml(msg.content)}
                    </div>
                </div>
            `;
        });
        
        bodyContent += `
                </div>
            </div>
        `;
    }
    
    document.getElementById('detailModalTitle').textContent = title;
    document.getElementById('detailModalBody').innerHTML = bodyContent;
    
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function goBack() {
    window.location.href = `/select_unit?class=${classNumber}&number=${studentNumber}`;
}
</script>
{% endblock %}
